<form class="{{cssClass}} flexcol" autocomplete="off">

  {{!-- Sheet Header --}}
  <header class="sheet-header">
    <div class="header-fields">
      <div class="name-row">
        <div class="name-field">
          <input name="name" type="text" value="{{actor.name}}" placeholder="Threat Name"/>
        </div>
        <div class="mode-toggle">
          <button type="button" class="toggle-edit-mode" title="Toggle Edit/Play Mode">
            {{#if editMode}}
              <i class="fas fa-eye"></i> Switch to Play Mode
            {{else}}
              <i class="fas fa-edit"></i> Switch to Edit Mode
            {{/if}}
          </button>
        </div>
      </div>

      {{!-- Aspects (visible on all tabs) --}}
      <div class="aspect-section">
        {{#each system.aspects as |aspect key|}}
          {{#if (or aspect.visible editMode)}}
            <div class="aspect-box {{#unless aspect.visible}}hidden-in-play{{/unless}}">
              {{#if editMode}}
                <div class="aspect-edit-controls">
                  <input type="text" name="system.aspects.{{key}}.label" value="{{aspect.label}}" placeholder="Aspect Label" class="aspect-label-edit"/>
                  <label class="aspect-visibility-label">
                    <input type="checkbox" class="aspect-visibility-toggle" data-aspect="{{key}}" {{checked aspect.visible}}/>
                    {{localize "SCIONS.Labels.Visible"}}
                  </label>
                </div>
              {{else}}
                <label>{{aspect.label}}</label>
              {{/if}}
              <input type="text" name="system.aspects.{{key}}.value" value="{{aspect.value}}" placeholder="{{aspect.label}}"/>
            </div>
          {{/if}}
        {{/each}}
      </div>
    </div>
    <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" height="100" width="100"/>
  </header>

  {{!-- Sheet Tab Navigation --}}
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="main">Main</a>
    <a class="item" data-tab="stunts">Stunts</a>
    <a class="item" data-tab="extras">Extras</a>
    <a class="item" data-tab="npcs">Named NPCs</a>
    <a class="item" data-tab="notes">Notes</a>
  </nav>

  {{!-- Sheet Body --}}
  <section class="sheet-body">

    {{!-- Main Tab --}}
    <div class="tab main-tab" data-group="primary" data-tab="main">
      <div class="two-column-layout">
        {{#each sortedSections as |section|}}
          {{!-- Render section based on key --}}
          {{#if (eq section.key "capabilitiesColumn")}}
            {{> threatSkillColumn section=section.data columnKey="capabilitiesColumn" editMode=../editMode}}
          {{else if (eq section.key "skillsColumn")}}
            {{> threatSkillColumn section=section.data columnKey="skillsColumn" editMode=../editMode}}
          {{else if (eq section.key "singlePointStress")}}
            {{> threatSinglePointStress section=section.data editMode=../editMode}}
          {{else if (eq section.key "growingStress")}}
            {{> threatGrowingStress section=section.data editMode=../editMode}}
          {{else if (eq section.key "consequences")}}
            {{> threatConsequences section=section.data editMode=../editMode}}
          {{else if (eq section.key "ageTrack")}}
            {{> threatAgeTrack section=section.data editMode=../editMode ageTrackValidation=../ageTrackValidation currentAgeStage=../currentAgeStage}}
          {{else if (eq section.key "ladder1")}}
            {{> threatLadder section=section.data ladderKey="ladder1" editMode=../editMode}}
          {{else if (eq section.key "ladder2")}}
            {{> threatLadder section=section.data ladderKey="ladder2" editMode=../editMode}}
          {{else if (eq section.key "details")}}
            {{> threatDetails section=section.data editMode=../editMode}}
          {{/if}}
        {{/each}}
      </div>
    </div>

    {{!-- Stunts Tab --}}
    <div class="tab stunts-tab" data-group="primary" data-tab="stunts">
      <div class="section-header">Stunts</div>

      {{#if (hasItems system.stunts)}}
        {{#each system.stunts as |stunt index|}}
          <div class="stunt-item">
            <div class="stunt-header">
              <input type="text" class="stunt-name" name="system.stunts.{{index}}.name" value="{{stunt.name}}" placeholder="Stunt Name"/>
              <button type="button" class="stunt-delete" data-index="{{index}}" title="Delete"><i class="fas fa-trash"></i></button>
            </div>
            <div class="stunt-description">
              {{editor stunt.description target=(concat "system.stunts." index ".description") button=true owner=owner editable=editable}}
            </div>
          </div>
        {{/each}}
      {{else}}
        <div class="empty-message">No stunts yet. Click the button below to add a stunt.</div>
      {{/if}}

      <button type="button" class="add-item-button stunt-add">
        <i class="fas fa-plus"></i> Add Stunt
      </button>
    </div>

    {{!-- Extras Tab --}}
    <div class="tab extras-tab" data-group="primary" data-tab="extras">
      <div class="section-header">Extras</div>

      {{!-- Extra Items List --}}
      <div class="extras-list">
        {{#if extraItems}}
          <ol class="items-list">
            {{#each extraItems as |item id|}}
              <li class="item extra-item" data-item-id="{{item._id}}" style="--tint-color: {{item.system.tintColor}};">
                <div class="extra-icon">
                  <img src="{{item.img}}" alt="{{item.name}}" title="{{item.name}}"/>
                </div>
                <div class="extra-content">
                  {{#if item.system.aspect}}
                    <div class="extra-aspect-display">
                      <span class="aspect-label">{{item.system.aspectLabel}}:</span>
                      <span class="aspect-value">{{item.system.aspect}}</span>
                    </div>
                  {{/if}}

                  {{!-- Free Invokes --}}
                  {{#if item.system.invokes}}
                    <div class="extra-invokes">
                      {{#each item.system.invokes as |invoke index|}}
                        <input type="checkbox"
                               class="invoke-checkbox"
                               data-item-id="{{item._id}}"
                               data-index="{{index}}"
                               {{checked invoke.spent}}
                               title="{{#if invoke.spent}}{{localize 'SCIONS.Extras.InvokeSpent'}}{{else}}{{localize 'SCIONS.Extras.InvokeAvailable'}}{{/if}}"/>
                      {{/each}}
                    </div>
                  {{/if}}

                  {{!-- Ladder (Extra-Ladder only) --}}
                  {{#if (eq item.type "extra-ladder")}}
                    <div class="extra-ladder-display">
                      <div class="ladder-label">{{item.system.ladderLabel}}</div>
                      <div class="ladder-rungs-vertical">
                        {{#each item.ladderData.rungs as |rung index|}}
                          <div class="ladder-rung-embedded {{#if rung.checked}}checked{{/if}} {{#if rung.isHighestUnchecked}}highest-unchecked{{/if}}">
                            <div class="ladder-rung-value-box ladder-rung-clickable" data-item-id="{{item._id}}" data-index="{{index}}">
                              {{#if (gt item.system.traumaValue 0)}}
                                <span class="rung-value">{{#if rung.checked}}✗{{else}}{{item.system.traumaValue}}{{/if}}</span>
                              {{else}}
                                <span class="rung-value">{{#if rung.checked}}✗{{/if}}</span>
                              {{/if}}
                            </div>
                            <span class="ladder-rung-aspect-embedded {{#if rung.checked}}checked-aspect{{/if}}">{{rung.aspect}}</span>
                          </div>
                        {{/each}}
                      </div>
                    </div>
                  {{/if}}

                  {{!-- Skill (Extra-Skill only) --}}
                  {{#if (eq item.type "extra-skill")}}
                    {{#if item.system.skillName}}
                      <div class="extra-skill-display">
                        <button type="button" class="roll-button roll-extra-skill" data-item-id="{{item._id}}" title="Roll {{item.system.skillName}}">
                          <i class="fas fa-dice-d6"></i>
                        </button>
                        <span class="skill-label">{{item.system.skillName}} {{signedNumber item.system.skillValue}}</span>
                      </div>
                    {{/if}}
                  {{/if}}

                  {{!-- Track (Extra-Track only) --}}
                  {{#if (eq item.type "extra-track")}}
                    <div class="extra-track-display">
                      <div class="track-label">{{item.system.trackLabel}}</div>
                      <div class="track-boxes-compact">
                        {{#each item.system.boxes as |box index|}}
                          <div class="track-box-wrapper {{#if box.checked}}checked{{/if}}"
                               data-item-id="{{item._id}}"
                               data-index="{{index}}"
                               title="Box {{add index 1}}">
                            {{#if (gt item.system.trackValue 0)}}
                              <span class="track-value">{{#if box.checked}}✗{{else}}{{item.system.trackValue}}{{/if}}</span>
                            {{else}}
                              <span class="track-value">{{#if box.checked}}✗{{/if}}</span>
                            {{/if}}
                          </div>
                        {{/each}}
                      </div>
                    </div>
                  {{/if}}

                  {{!-- Growing Track (Extra-Growing-Track only) --}}
                  {{#if (eq item.type "extra-growing-track")}}
                    <div class="extra-track-display">
                      <div class="track-label">{{item.system.trackLabel}}</div>
                      <div class="track-boxes-compact">
                        {{#each item.system.boxes as |box index|}}
                          <div class="track-box-wrapper {{#if box.checked}}checked{{/if}}"
                               data-item-id="{{item._id}}"
                               data-index="{{index}}"
                               title="Box {{add index 1}}">
                            <span class="track-value">{{#if box.checked}}✗{{else}}{{add index 1}}{{/if}}</span>
                          </div>
                        {{/each}}
                      </div>
                    </div>
                  {{/if}}
                </div>

                <div class="item-controls">
                  <a class="item-control item-edit" title="{{localize 'SCIONS.Extras.EditExtra'}}"><i class="fas fa-edit"></i></a>
                  <a class="item-control item-delete" title="{{localize 'SCIONS.Extras.DeleteExtra'}}"><i class="fas fa-trash"></i></a>
                </div>
              </li>
            {{/each}}
          </ol>
        {{else}}
          <div class="empty-message">
            <p>{{localize "SCIONS.Extras.NoExtras"}}</p>
          </div>
        {{/if}}
      </div>
    </div>

    {{!-- Named NPCs Tab --}}
    <div class="tab npcs-tab" data-group="primary" data-tab="npcs">
      <div class="section-header">Named NPCs</div>

      {{!-- NPC Items List --}}
      <div class="npc-list">
        {{#if npcItems}}
          <ol class="items-list">
            {{#each npcItems as |item id|}}
              <li class="item npc-item flexrow {{#if item.npcData.isDeceased}}deceased{{/if}}" data-item-id="{{item._id}}">
                <div class="item-details">
                  <div class="item-name">
                    <h4>{{item.name}}</h4>
                    {{#if item.system.aspect}}
                      <div class="item-aspect">{{item.system.aspect}}</div>
                    {{/if}}
                  </div>
                  <div class="item-info">
                    <div class="npc-age-status {{#if item.npcData.isDeceased}}deceased{{/if}}">
                      {{#if item.npcData.isDeceased}}
                        Deceased (Gen {{item.npcData.deathGeneration}})
                      {{else}}
                        {{item.npcData.currentAgeLabel}}
                      {{/if}}
                    </div>
                    {{#if item.system.skillName}}
                      <div class="npc-skill-info">
                        <button type="button" class="roll-button roll-npc-skill rollable" title="Roll {{item.system.skillName}}">
                          <i class="fas fa-dice-d6"></i>
                        </button>
                        <span class="skill-label">{{item.system.skillName}} {{signedNumber item.system.skillValue}}</span>
                      </div>
                    {{/if}}
                  </div>
                </div>
                <div class="item-controls">
                  <a class="item-control item-edit" title="Edit NPC"><i class="fas fa-edit"></i></a>
                  <a class="item-control item-delete" title="Delete NPC"><i class="fas fa-trash"></i></a>
                </div>
              </li>
            {{/each}}
          </ol>
        {{else}}
          <div class="empty-message">
            <p>No NPCs for this threat. Create named NPCs from the Items directory and drag them here.</p>
          </div>
        {{/if}}
      </div>

    </div>

    {{!-- Notes Tab --}}
    <div class="tab notes-tab" data-group="primary" data-tab="notes">
      <div class="section-header">Notes</div>
      <div class="editor-container">
        {{editor system.notes target="system.notes" button=true owner=owner editable=editable}}
      </div>
    </div>

  </section>

</form>

{{!-- Partial: Skill Column (Capabilities or Skills) --}}
{{#*inline "threatSkillColumn"}}
  <div class="section-box skill-column-section {{#if editMode}}{{#if section.visible}}section-visible-in-edit{{else}}section-hidden-in-edit{{/if}}{{/if}}">
    <div class="section-header-row">
      {{#if editMode}}
        <input type="text" name="system.modularSections.{{columnKey}}.heading" value="{{section.heading}}" class="section-heading-edit"/>
        <label>
          <input type="checkbox" class="section-visibility-toggle" data-section="{{columnKey}}" {{checked section.visible}}/>
          {{localize "SCIONS.Labels.Visible"}}
        </label>
        <label>{{localize "SCIONS.Threat.Priority"}}: <input type="number" name="system.modularSections.{{columnKey}}.priority" value="{{section.priority}}" class="priority-input"/></label>
        <div class="skill-count-controls">
          <button type="button" class="skill-count-decrement" data-column="{{columnKey}}" title="Decrease">−</button>
          <span>{{section.skillCount}}/8 skills</span>
          <button type="button" class="skill-count-increment" data-column="{{columnKey}}" title="Increase">+</button>
        </div>
      {{else}}
        <div class="subsection-header">{{section.heading}}</div>
      {{/if}}
    </div>

    <div class="skills-list">
      {{#each section.skills as |skill index|}}
        {{#if (lt index ../section.skillCount)}}
          <div class="skill-item">
            {{#unless ../editMode}}
              {{#if skill.name}}
                <button type="button" class="roll-button roll-skill rollable" data-column="{{../columnKey}}" data-index="{{index}}" title="Roll {{skill.name}}">
                  <i class="fas fa-dice-d6"></i>
                </button>
              {{/if}}
            {{/unless}}
            <input type="number" class="skill-value" name="system.modularSections.{{../columnKey}}.skills.{{index}}.value" value="{{skill.value}}" data-dtype="Number" min="-1" max="10"/>
            {{#if ../editMode}}
              <input type="text" class="skill-name-edit" name="system.modularSections.{{../columnKey}}.skills.{{index}}.name" value="{{skill.name}}" placeholder="{{localize 'SCIONS.Threat.SkillName'}}"/>
            {{else}}
              <span class="skill-label">{{skill.name}}</span>
            {{/if}}
          </div>
        {{/if}}
      {{/each}}
    </div>
  </div>
{{/inline}}

{{!-- Partial: Single-Point Stress Tracks --}}
{{#*inline "threatSinglePointStress"}}
  <div class="section-box stress-section {{#if editMode}}{{#if section.visible}}section-visible-in-edit{{else}}section-hidden-in-edit{{/if}}{{/if}}">
    <div class="section-header-row">
      {{#if editMode}}
        <input type="text" name="system.modularSections.singlePointStress.heading" value="{{section.heading}}" class="section-heading-edit"/>
        <label>
          <input type="checkbox" class="section-visibility-toggle" data-section="singlePointStress" {{checked section.visible}}/>
          {{localize "SCIONS.Labels.Visible"}}
        </label>
        <label>
          <input type="checkbox" name="system.modularSections.singlePointStress.countsTowardTrauma" {{checked section.countsTowardTrauma}} data-dtype="Boolean"/>
          {{localize "SCIONS.Threat.CountsTowardTrauma"}}
        </label>
        <label>{{localize "SCIONS.Threat.Priority"}}: <input type="number" name="system.modularSections.singlePointStress.priority" value="{{section.priority}}" class="priority-input"/></label>
      {{else}}
        <div class="subsection-header">{{section.heading}}</div>
      {{/if}}
    </div>

    {{!-- Track 1 --}}
    {{#if (or section.track1.visible editMode)}}
      <div class="stress-track-row">
        {{#if editMode}}
          <input type="text" name="system.modularSections.singlePointStress.track1.label" value="{{section.track1.label}}" class="track-label-edit"/>
          <label>
            <input type="checkbox" class="track-visibility-toggle" data-section="singlePointStress" data-track="track1" {{checked section.track1.visible}}/>
            {{localize "SCIONS.Labels.Visible"}}
          </label>
          <label>{{localize "SCIONS.Threat.TraumaValue"}}:
            <input type="number" name="system.modularSections.singlePointStress.track1.traumaValue" value="{{section.track1.traumaValue}}" min="0" class="trauma-value-input"/>
          </label>
          <div class="stress-max-controls">
            <button type="button" class="stress-max-decrement" data-section="singlePointStress" data-track="track1" title="Decrease">−</button>
            <span>{{section.track1.max}} {{localize "SCIONS.Threat.Boxes"}}</span>
            <button type="button" class="stress-max-increment" data-section="singlePointStress" data-track="track1" title="Increase">+</button>
          </div>
        {{else}}
          <label>{{section.track1.label}}:</label>
        {{/if}}
        <div class="stress-boxes">
          {{#each section.track1.boxes as |box index|}}
            <div class="stress-box {{#if box.value}}checked{{/if}}" data-track="track1" data-index="{{index}}" title="Toggle">
              {{#if (gt ../section.track1.traumaValue 0)}}
                <span class="box-value">{{#if box.value}}✗{{else}}{{../section.track1.traumaValue}}{{/if}}</span>
              {{else}}
                <span class="box-value">{{#if box.value}}✗{{/if}}</span>
              {{/if}}
            </div>
          {{/each}}
        </div>
      </div>
    {{/if}}

    {{!-- Track 2 --}}
    {{#if (or section.track2.visible editMode)}}
      <div class="stress-track-row">
        {{#if editMode}}
          <input type="text" name="system.modularSections.singlePointStress.track2.label" value="{{section.track2.label}}" class="track-label-edit"/>
          <label>
            <input type="checkbox" class="track-visibility-toggle" data-section="singlePointStress" data-track="track2" {{checked section.track2.visible}}/>
            {{localize "SCIONS.Labels.Visible"}}
          </label>
          <label>{{localize "SCIONS.Threat.TraumaValue"}}:
            <input type="number" name="system.modularSections.singlePointStress.track2.traumaValue" value="{{section.track2.traumaValue}}" min="0" class="trauma-value-input"/>
          </label>
          <div class="stress-max-controls">
            <button type="button" class="stress-max-decrement" data-section="singlePointStress" data-track="track2" title="Decrease">−</button>
            <span>{{section.track2.max}} {{localize "SCIONS.Threat.Boxes"}}</span>
            <button type="button" class="stress-max-increment" data-section="singlePointStress" data-track="track2" title="Increase">+</button>
          </div>
        {{else}}
          <label>{{section.track2.label}}:</label>
        {{/if}}
        <div class="stress-boxes">
          {{#each section.track2.boxes as |box index|}}
            <div class="stress-box {{#if box.value}}checked{{/if}}" data-track="track2" data-index="{{index}}" title="Toggle">
              {{#if (gt ../section.track2.traumaValue 0)}}
                <span class="box-value">{{#if box.value}}✗{{else}}{{../section.track2.traumaValue}}{{/if}}</span>
              {{else}}
                <span class="box-value">{{#if box.value}}✗{{/if}}</span>
              {{/if}}
            </div>
          {{/each}}
        </div>
      </div>
    {{/if}}
  </div>
{{/inline}}

{{!-- Partial: Growing Stress Tracks --}}
{{#*inline "threatGrowingStress"}}
  <div class="section-box stress-section {{#if editMode}}{{#if section.visible}}section-visible-in-edit{{else}}section-hidden-in-edit{{/if}}{{/if}}">
    <div class="section-header-row">
      {{#if editMode}}
        <input type="text" name="system.modularSections.growingStress.heading" value="{{section.heading}}" class="section-heading-edit"/>
        <label>
          <input type="checkbox" class="section-visibility-toggle" data-section="growingStress" {{checked section.visible}}/>
          {{localize "SCIONS.Labels.Visible"}}
        </label>
        <label>{{localize "SCIONS.Threat.Priority"}}: <input type="number" name="system.modularSections.growingStress.priority" value="{{section.priority}}" class="priority-input"/></label>
      {{else}}
        <div class="subsection-header">{{section.heading}}</div>
      {{/if}}
    </div>

    {{!-- Track 1 --}}
    {{#if (or section.track1.visible editMode)}}
      <div class="stress-track-row">
        {{#if editMode}}
          <input type="text" name="system.modularSections.growingStress.track1.label" value="{{section.track1.label}}" class="track-label-edit"/>
          <label>
            <input type="checkbox" class="track-visibility-toggle" data-section="growingStress" data-track="track1" {{checked section.track1.visible}}/>
            {{localize "SCIONS.Labels.Visible"}}
          </label>
          <label>
            <input type="checkbox" name="system.modularSections.growingStress.track1.countsTowardTrauma" {{checked section.track1.countsTowardTrauma}} data-dtype="Boolean"/>
            {{localize "SCIONS.Threat.CountsTowardTrauma"}}
          </label>
          <div class="stress-max-controls">
            <button type="button" class="stress-max-decrement" data-section="growingStress" data-track="track1" title="Decrease">−</button>
            <span>{{section.track1.max}} {{localize "SCIONS.Threat.Boxes"}}</span>
            <button type="button" class="stress-max-increment" data-section="growingStress" data-track="track1" title="Increase">+</button>
          </div>
        {{else}}
          <label>{{section.track1.label}}:</label>
        {{/if}}
        <div class="stress-boxes">
          {{#each section.track1.boxes as |box index|}}
            <label class="growing-stress-box {{#if box.value}}checked{{/if}}">
              <input type="checkbox" class="stress-box-checkbox-hidden" name="system.modularSections.growingStress.track1.boxes.{{index}}.value" {{checked box.value}} data-dtype="Boolean"/>
              <span class="stress-box-number">{{add index 1}}</span>
            </label>
          {{/each}}
        </div>
      </div>
    {{/if}}

    {{!-- Track 2 --}}
    {{#if (or section.track2.visible editMode)}}
      <div class="stress-track-row">
        {{#if editMode}}
          <input type="text" name="system.modularSections.growingStress.track2.label" value="{{section.track2.label}}" class="track-label-edit"/>
          <label>
            <input type="checkbox" class="track-visibility-toggle" data-section="growingStress" data-track="track2" {{checked section.track2.visible}}/>
            {{localize "SCIONS.Labels.Visible"}}
          </label>
          <label>
            <input type="checkbox" name="system.modularSections.growingStress.track2.countsTowardTrauma" {{checked section.track2.countsTowardTrauma}} data-dtype="Boolean"/>
            {{localize "SCIONS.Threat.CountsTowardTrauma"}}
          </label>
          <div class="stress-max-controls">
            <button type="button" class="stress-max-decrement" data-section="growingStress" data-track="track2" title="Decrease">−</button>
            <span>{{section.track2.max}} {{localize "SCIONS.Threat.Boxes"}}</span>
            <button type="button" class="stress-max-increment" data-section="growingStress" data-track="track2" title="Increase">+</button>
          </div>
        {{else}}
          <label>{{section.track2.label}}:</label>
        {{/if}}
        <div class="stress-boxes">
          {{#each section.track2.boxes as |box index|}}
            <label class="growing-stress-box {{#if box.value}}checked{{/if}}">
              <input type="checkbox" class="stress-box-checkbox-hidden" name="system.modularSections.growingStress.track2.boxes.{{index}}.value" {{checked box.value}} data-dtype="Boolean"/>
              <span class="stress-box-number">{{add index 1}}</span>
            </label>
          {{/each}}
        </div>
      </div>
    {{/if}}
  </div>
{{/inline}}

{{!-- Partial: Consequences --}}
{{#*inline "threatConsequences"}}
  <div class="section-box consequences-section {{#if editMode}}{{#if section.visible}}section-visible-in-edit{{else}}section-hidden-in-edit{{/if}}{{/if}}">
    <div class="section-header-row">
      {{#if editMode}}
        <input type="text" name="system.modularSections.consequences.heading" value="{{section.heading}}" class="section-heading-edit"/>
        <label>
          <input type="checkbox" class="section-visibility-toggle" data-section="consequences" {{checked section.visible}}/>
          {{localize "SCIONS.Labels.Visible"}}
        </label>
        <label>
          <input type="checkbox" name="system.modularSections.consequences.countsTowardTrauma" {{checked section.countsTowardTrauma}} data-dtype="Boolean"/>
          {{localize "SCIONS.Threat.CountsTowardTrauma"}}
        </label>
        <label>{{localize "SCIONS.Threat.Priority"}}: <input type="number" name="system.modularSections.consequences.priority" value="{{section.priority}}" class="priority-input"/></label>
      {{else}}
        <div class="subsection-header">{{section.heading}}</div>
      {{/if}}
    </div>

    {{!-- Minor (2) --}}
    {{#if (or section.minor.visible editMode)}}
      <div class="consequence-box minor {{#if section.minor.value}}active{{/if}} {{#if section.minor.treated}}treated{{/if}}">
        <div class="consequence-header">
          <label class="consequence-label">{{localize "SCIONS.Consequences.Minor"}}</label>
          {{#if editMode}}
            <label>
              <input type="checkbox" class="consequence-visibility-toggle" data-consequence="minor" {{checked section.minor.visible}}/>
              {{localize "SCIONS.Labels.Visible"}}
            </label>
          {{/if}}
          <div class="consequence-status">
            {{#if section.minor.value}}
              {{#if section.minor.treated}}
                <span class="status-badge treated">Treated</span>
              {{else}}
                <span class="status-badge active">Active</span>
              {{/if}}
            {{else}}
              <span class="status-badge unused">Unused</span>
            {{/if}}
            <label class="treated-checkbox">
              <input type="checkbox" name="system.modularSections.consequences.minor.treated" {{checked section.minor.treated}} data-dtype="Boolean"/>
              {{localize "SCIONS.Consequences.MarkTreated"}}
            </label>
            <label class="free-invoke-checkbox">
              <input type="checkbox" name="system.modularSections.consequences.minor.freeInvoke" {{checked section.minor.freeInvoke}} data-dtype="Boolean"/>
              {{localize "SCIONS.Consequences.FreeInvoke"}}
            </label>
          </div>
        </div>
        <input type="text" name="system.modularSections.consequences.minor.value" value="{{section.minor.value}}" placeholder="{{localize 'SCIONS.Consequences.MinorPlaceholder'}}"/>
      </div>
    {{/if}}

    {{!-- Minor2 (2) --}}
    {{#if (or section.minor2.visible editMode)}}
      <div class="consequence-box minor {{#if section.minor2.value}}active{{/if}} {{#if section.minor2.treated}}treated{{/if}}">
        <div class="consequence-header">
          <label class="consequence-label">{{localize "SCIONS.Consequences.Minor"}}</label>
          {{#if editMode}}
            <label>
              <input type="checkbox" class="consequence-visibility-toggle" data-consequence="minor2" {{checked section.minor2.visible}}/>
              {{localize "SCIONS.Labels.Visible"}}
            </label>
          {{/if}}
          <div class="consequence-status">
            {{#if section.minor2.value}}
              {{#if section.minor2.treated}}
                <span class="status-badge treated">Treated</span>
              {{else}}
                <span class="status-badge active">Active</span>
              {{/if}}
            {{else}}
              <span class="status-badge unused">Unused</span>
            {{/if}}
            <label class="treated-checkbox">
              <input type="checkbox" name="system.modularSections.consequences.minor2.treated" {{checked section.minor2.treated}} data-dtype="Boolean"/>
              {{localize "SCIONS.Consequences.MarkTreated"}}
            </label>
            <label class="free-invoke-checkbox">
              <input type="checkbox" name="system.modularSections.consequences.minor2.freeInvoke" {{checked section.minor2.freeInvoke}} data-dtype="Boolean"/>
              {{localize "SCIONS.Consequences.FreeInvoke"}}
            </label>
          </div>
        </div>
        <input type="text" name="system.modularSections.consequences.minor2.value" value="{{section.minor2.value}}" placeholder="{{localize 'SCIONS.Consequences.MinorPlaceholder'}}"/>
      </div>
    {{/if}}

    {{!-- Moderate (4) --}}
    {{#if (or section.moderate.visible editMode)}}
      <div class="consequence-box {{#if section.moderate.value}}active{{/if}} {{#if section.moderate.treated}}treated{{/if}}">
        <div class="consequence-header">
          <label class="consequence-label">{{localize "SCIONS.Consequences.Moderate"}}</label>
          {{#if editMode}}
            <label>
              <input type="checkbox" class="consequence-visibility-toggle" data-consequence="moderate" {{checked section.moderate.visible}}/>
              {{localize "SCIONS.Labels.Visible"}}
            </label>
          {{/if}}
          <div class="consequence-status">
            {{#if section.moderate.value}}
              {{#if section.moderate.treated}}
                <span class="status-badge treated">Treated</span>
              {{else}}
                <span class="status-badge active">Active</span>
              {{/if}}
            {{else}}
              <span class="status-badge unused">Unused</span>
            {{/if}}
            <label class="treated-checkbox">
              <input type="checkbox" name="system.modularSections.consequences.moderate.treated" {{checked section.moderate.treated}} data-dtype="Boolean"/>
              {{localize "SCIONS.Consequences.MarkTreated"}}
            </label>
            <label class="free-invoke-checkbox">
              <input type="checkbox" name="system.modularSections.consequences.moderate.freeInvoke" {{checked section.moderate.freeInvoke}} data-dtype="Boolean"/>
              {{localize "SCIONS.Consequences.FreeInvoke"}}
            </label>
          </div>
        </div>
        <input type="text" name="system.modularSections.consequences.moderate.value" value="{{section.moderate.value}}" placeholder="{{localize 'SCIONS.Consequences.ModeratePlaceholder'}}"/>
      </div>
    {{/if}}

    {{!-- Severe (6) --}}
    {{#if (or section.severe.visible editMode)}}
      <div class="consequence-box severe {{#if section.severe.value}}active{{/if}} {{#if section.severe.treated}}treated{{/if}}">
        <div class="consequence-header">
          <label class="consequence-label">{{localize "SCIONS.Consequences.Severe"}}</label>
          {{#if editMode}}
            <label>
              <input type="checkbox" class="consequence-visibility-toggle" data-consequence="severe" {{checked section.severe.visible}}/>
              {{localize "SCIONS.Labels.Visible"}}
            </label>
          {{/if}}
          <div class="consequence-status">
            {{#if section.severe.value}}
              {{#if section.severe.treated}}
                <span class="status-badge treated">Treated</span>
              {{else}}
                <span class="status-badge active">Active</span>
              {{/if}}
            {{else}}
              <span class="status-badge unused">Unused</span>
            {{/if}}
            <label class="treated-checkbox">
              <input type="checkbox" name="system.modularSections.consequences.severe.treated" {{checked section.severe.treated}} data-dtype="Boolean"/>
              {{localize "SCIONS.Consequences.MarkTreated"}}
            </label>
            <label class="free-invoke-checkbox">
              <input type="checkbox" name="system.modularSections.consequences.severe.freeInvoke" {{checked section.severe.freeInvoke}} data-dtype="Boolean"/>
              {{localize "SCIONS.Consequences.FreeInvoke"}}
            </label>
          </div>
        </div>
        <input type="text" name="system.modularSections.consequences.severe.value" value="{{section.severe.value}}" placeholder="{{localize 'SCIONS.Consequences.SeverePlaceholder'}}"/>
      </div>
    {{/if}}
  </div>
{{/inline}}

{{!-- Partial: Age Track --}}
{{#*inline "threatAgeTrack"}}
  <div class="section-box age-track-section {{#if editMode}}{{#if section.visible}}section-visible-in-edit{{else}}section-hidden-in-edit{{/if}}{{/if}}">
    <div class="section-header-row">
      {{#if editMode}}
        <input type="text" name="system.modularSections.ageTrack.heading" value="{{section.heading}}" class="section-heading-edit"/>
        <label>
          <input type="checkbox" class="section-visibility-toggle" data-section="ageTrack" {{checked section.visible}}/>
          {{localize "SCIONS.Labels.Visible"}}
        </label>
        <label>
          <input type="checkbox" name="system.modularSections.ageTrack.countsTowardTrauma" {{checked section.countsTowardTrauma}} data-dtype="Boolean"/>
          {{localize "SCIONS.Threat.CountsTowardTrauma"}}
        </label>
        <label>{{localize "SCIONS.Threat.Priority"}}: <input type="number" name="system.modularSections.ageTrack.priority" value="{{section.priority}}" class="priority-input"/></label>
      {{else}}
        <div class="subsection-header">{{section.heading}}</div>
      {{/if}}
    </div>

    <div class="age-track-table">
      <div class="age-track-header">
        <div class="age-track-cell age-header"></div>
        <div class="age-track-cell age-header" title="{{localize 'SCIONS.AgeTrack.WoundHint'}}">{{localize "SCIONS.AgeTrack.Wound"}}</div>
        <div class="age-track-cell age-header" title="{{localize 'SCIONS.AgeTrack.InvokeHint'}}">{{localize "SCIONS.AgeTrack.Invoke"}}</div>
        <div class="age-track-cell age-header" title="{{localize 'SCIONS.AgeTrack.ScarHint'}}">{{localize "SCIONS.AgeTrack.Scar"}}</div>
        <div class="age-track-cell age-header" title="{{localize 'SCIONS.AgeTrack.PassedHint'}}">{{localize "SCIONS.AgeTrack.Passed"}}</div>
      </div>
      {{#each section.stages as |stage key|}}
        <div class="age-track-row">
          <div class="age-track-cell age-label {{#if (eq ../currentAgeStage key)}}current-age{{/if}} {{#if stage.passed}}passed-age{{/if}} {{#if stage.scar}}scarred-age{{/if}}" title="{{stage.ageRange}}">{{stage.label}}</div>
          <div class="age-track-cell age-checkbox wound-cell">
            <div class="wound-stress-box {{#if stage.wound}}checked{{/if}} {{#if stage.scar}}hidden{{/if}} {{#if stage.passed}}hidden{{/if}}" data-stage="{{key}}" title="Wound"></div>
          </div>
          <div class="age-track-cell age-checkbox">
            <input type="checkbox" class="age-invoke-used {{#unless stage.wound}}hidden{{/unless}} {{#if stage.scar}}hidden{{/if}} {{#if stage.passed}}hidden{{/if}}" data-stage="{{key}}" {{checked stage.freeInvokeUsed}} title="Invoke Used"/>
          </div>
          <div class="age-track-cell age-checkbox">
            <input type="checkbox" class="age-scar {{#if stage.passed}}hidden{{/if}} {{#unless (lookup (lookup ../ageTrackValidation key) 'canCheckScar')}}disabled-checkbox{{/unless}}" data-stage="{{key}}" {{checked stage.scar}} title="Scar"/>
          </div>
          <div class="age-track-cell age-checkbox">
            <input type="checkbox" class="age-passed {{#if stage.scar}}hidden{{/if}} {{#unless (lookup (lookup ../ageTrackValidation key) 'canCheckPassed')}}disabled-checkbox{{/unless}}" data-stage="{{key}}" {{checked stage.passed}} title="Passed"/>
          </div>
        </div>
      {{/each}}
    </div>
  </div>
{{/inline}}

{{!-- Partial: Ladder Track --}}
{{#*inline "threatLadder"}}
  <div class="section-box ladder-section {{#if editMode}}{{#if section.visible}}section-visible-in-edit{{else}}section-hidden-in-edit{{/if}}{{/if}}">
    <div class="section-header-row">
      {{#if editMode}}
        <input type="text" name="system.modularSections.{{ladderKey}}.heading" value="{{section.heading}}" class="section-heading-edit"/>
        <label>
          <input type="checkbox" class="section-visibility-toggle" data-section="{{ladderKey}}" {{checked section.visible}}/>
          {{localize "SCIONS.Labels.Visible"}}
        </label>
        <label>
          <input type="checkbox" name="system.modularSections.{{ladderKey}}.countsTowardTrauma" {{checked section.countsTowardTrauma}} data-dtype="Boolean"/>
          {{localize "SCIONS.Threat.CountsTowardTrauma"}}
        </label>
        <label>{{localize "SCIONS.Threat.Priority"}}: <input type="number" name="system.modularSections.{{ladderKey}}.priority" value="{{section.priority}}" class="priority-input"/></label>
        <label>{{localize "SCIONS.Threat.TraumaValue"}}:
          <input type="number" name="system.modularSections.{{ladderKey}}.traumaValue" value="{{section.traumaValue}}" min="0" class="trauma-value-input"/>
        </label>
        <div class="ladder-rung-controls">
          <button type="button" class="ladder-rung-decrement" data-ladder="{{ladderKey}}" title="Decrease">−</button>
          <span>{{section.rungCount}} {{localize "SCIONS.Threat.Rungs"}}</span>
          <button type="button" class="ladder-rung-increment" data-ladder="{{ladderKey}}" title="Increase">+</button>
        </div>
      {{else}}
        <div class="subsection-header">{{section.heading}}</div>
      {{/if}}
    </div>

    <div class="ladder-track">
      {{#each (getLadderRungs section) as |rung index|}}
        <div class="ladder-rung {{#if rung.checked}}checked{{/if}} {{#if (eq index (getHighestUncheckedRung ../section))}}highest-unchecked{{/if}}">
          {{#unless ../editMode}}
            <div class="ladder-rung-value-box ladder-rung-clickable" data-ladder="{{../ladderKey}}" data-index="{{index}}">
              {{#if (gt ../section.traumaValue 0)}}
                <span class="rung-value">{{#if rung.checked}}✗{{else}}{{../section.traumaValue}}{{/if}}</span>
              {{else}}
                <span class="rung-value">{{#if rung.checked}}✗{{/if}}</span>
              {{/if}}
            </div>
          {{else}}
            <div class="ladder-rung-value-box">
              {{#if (gt ../section.traumaValue 0)}}
                <span class="rung-value">{{#if rung.checked}}✗{{else}}{{../section.traumaValue}}{{/if}}</span>
              {{else}}
                <span class="rung-value">{{#if rung.checked}}✗{{/if}}</span>
              {{/if}}
            </div>
          {{/unless}}
          <input type="hidden" name="system.modularSections.{{../ladderKey}}.rungs.{{index}}.checked" value="{{rung.checked}}" data-dtype="Boolean"/>
          <input type="text" name="system.modularSections.{{../ladderKey}}.rungs.{{index}}.aspect" value="{{rung.aspect}}" placeholder="Rung {{add index 1}}" class="ladder-rung-aspect {{#if rung.checked}}checked-aspect{{/if}}"/>
        </div>
      {{/each}}
    </div>
  </div>
{{/inline}}


{{!-- Partial: Details Section --}}
{{#*inline "threatDetails"}}
  <div class="section-box details-section {{#if editMode}}{{#if section.visible}}section-visible-in-edit{{else}}section-hidden-in-edit{{/if}}{{/if}}">
    <div class="section-header-row">
      {{#if editMode}}
        <input type="text" name="system.modularSections.details.heading" value="{{section.heading}}" class="section-heading-edit"/>
        <label>
          <input type="checkbox" class="section-visibility-toggle" data-section="details" {{checked section.visible}}/>
          {{localize "SCIONS.Labels.Visible"}}
        </label>
        <label>{{localize "SCIONS.Threat.Priority"}}: <input type="number" name="system.modularSections.details.priority" value="{{section.priority}}" class="priority-input"/></label>
      {{else}}
        <div class="subsection-header">{{section.heading}}</div>
      {{/if}}
    </div>

    <div class="details-content">
      {{editor section.content target="system.modularSections.details.content" button=true owner=owner editable=editable}}
    </div>
  </div>
{{/inline}}
