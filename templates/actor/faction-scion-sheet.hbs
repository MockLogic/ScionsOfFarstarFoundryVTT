<form class="{{cssClass}} flexcol" autocomplete="off">

  {{!-- Sheet Header --}}
  <header class="sheet-header">
    <div class="header-fields">
      <div class="name-row">
        <div class="name-field">
          <label class="field-label">{{localize "SCIONS.Faction.FactionName"}}</label>
          <input name="name" type="text" value="{{actor.name}}" placeholder="{{localize 'SCIONS.Faction.FactionName'}}"/>
        </div>
        <div class="name-field">
          <label class="field-label">{{localize "SCIONS.Scion.ScionName"}}</label>
          <input name="system.scion.name" type="text" value="{{system.scion.name}}" placeholder="{{localize 'SCIONS.Scion.ScionName'}}"/>
        </div>
      </div>
      <div class="resource-row">
        <div class="resource refresh-display">
          <label class="resource-label">{{localize "SCIONS.Faction.Refresh"}}</label>
          <div class="refresh-value {{#unless system.faction.refreshValid}}invalid{{/unless}}" title="{{localize 'SCIONS.Faction.RefreshHint'}}">{{system.faction.refresh.value}}</div>
        </div>
        <div class="resource fate-points-display">
          <label class="resource-label">{{localize "SCIONS.Faction.FatePoints"}}</label>
          <div class="fate-point-controls">
            <button type="button" class="fate-points-decrement" title="{{localize 'SCIONS.Actions.Decrease'}}">−</button>
            <input type="number" name="system.faction.fatePoints.value" value="{{system.faction.fatePoints.value}}" data-dtype="Number"/>
            <button type="button" class="fate-points-increment" title="{{localize 'SCIONS.Actions.Increase'}}">+</button>
          </div>
        </div>
        <div class="resource roll-fate-inline">
          <button type="button" class="roll-button roll-fate-header">
            <i class="fas fa-dice"></i> {{localize "SCIONS.Roll.RollFate"}}
          </button>
        </div>
      </div>
      <div class="aspect-row">
        <div class="aspect-box">
          <label>{{localize "SCIONS.Faction.HighConcept"}}</label>
          <input type="text" name="system.aspects.highConcept.value" value="{{system.aspects.highConcept.value}}" placeholder="{{localize 'SCIONS.Faction.HighConcept'}}"/>
        </div>
        <div class="aspect-box">
          <label>{{localize "SCIONS.Faction.Trouble"}}</label>
          <input type="text" name="system.aspects.trouble.value" value="{{system.aspects.trouble.value}}" placeholder="{{localize 'SCIONS.Faction.Trouble'}}"/>
        </div>
      </div>
      {{#unless system.faction.refreshValid}}
        <div class="validation-warning">⚠ {{localize "SCIONS.Validation.RefreshMismatch"}}</div>
      {{/unless}}
    </div>
    <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" height="100" width="100"/>
  </header>

  {{!-- Sheet Tab Navigation --}}
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="main">{{localize "SCIONS.Tabs.Main"}}</a>
    <a class="item" data-tab="stunts">{{localize "SCIONS.Tabs.Stunts"}}</a>
    <a class="item" data-tab="extras">{{localize "SCIONS.Tabs.Extras"}}</a>
    <a class="item" data-tab="npcs">Named NPCs</a>
    <a class="item" data-tab="notes">{{localize "SCIONS.Tabs.Notes"}}</a>
  </nav>

  {{!-- Sheet Body --}}
  <section class="sheet-body">

    {{!-- Main Tab: Faction and Scion Side by Side --}}
    <div class="tab main-tab" data-group="primary" data-tab="main">
      <div class="two-column-layout">

        {{!-- Left Column: Faction --}}
        <div class="column faction-column">
          <div class="section-header">{{localize "SCIONS.Faction.Title"}}</div>

          {{!-- Inheritance Aspect --}}
          <div class="aspect-box">
            <label>{{localize "SCIONS.Faction.Inheritance"}}</label>
            <input type="text" name="system.faction.aspects.inheritance.value" value="{{system.faction.aspects.inheritance.value}}" placeholder="{{localize 'SCIONS.Faction.Inheritance'}}"/>
          </div>

          {{!-- Capabilities --}}
          <div class="subsection-header">
            {{localize "SCIONS.Faction.Capabilities"}}
            {{#unless system.faction.capabilityValidation.valid}}
              <span class="validation-warning">⚠</span>
            {{/unless}}
          </div>

          <div class="capabilities-list">
            {{#each system.faction.capabilities as |capability key|}}
              <div class="capability-item" data-capability="{{key}}" draggable="true" title="Drag to hotbar to create macro">
                <button type="button" class="roll-button roll-capability" data-capability="{{key}}" title="{{localize 'SCIONS.Roll.Roll'}} {{capability.label}}">
                  <i class="fas fa-dice-d6"></i>
                </button>
                <input type="number" class="capability-value {{#if (lookup ../system.faction.capabilityValidation.invalidCapabilities key)}}invalid{{/if}}" name="system.faction.capabilities.{{key}}.value" value="{{capability.value}}" data-dtype="Number" min="{{#if (eq key 'people')}}0{{else}}-1{{/if}}" max="10"/>
                <span class="capability-label">{{capability.label}}</span>
              </div>
            {{/each}}
          </div>

          {{!-- Capability Validation Warnings --}}
          {{#unless system.faction.capabilityValidation.valid}}
            <div class="validation-section">
              {{#each system.faction.capabilityValidation.errors as |error|}}
                <div class="validation-warning">⚠ {{error}}</div>
              {{/each}}
            </div>
          {{/unless}}

          {{!-- People Track --}}
          <div class="subsection-header people-track-header">
            <span>{{localize "SCIONS.Faction.PeopleTrack"}}</span>
            <span class="track-legend-inline">{{localize "SCIONS.PeopleTrack.Legend"}}: {{localize "SCIONS.PeopleTrack.Empty"}} → {{localize "SCIONS.PeopleTrack.Committed"}} → {{localize "SCIONS.PeopleTrack.Expended"}}</span>
          </div>
          <div class="people-track">
            {{#each system.faction.peopleTrack.boxes as |box index|}}
              <div class="people-box-container">
                <div class="box-value-label">{{box.value}}</div>
                <div class="people-box growing {{#if box.committed}}committed{{/if}} {{#if box.expended}}expended{{/if}}"
                     data-index="{{index}}"
                     data-value="{{box.value}}"
                     title="{{localize 'SCIONS.PeopleTrack.ClickInstructions'}}">
                  {{#if box.expended}}
                    <span class="box-number expended-number">{{box.value}}</span>
                  {{else if box.committed}}
                    <span class="box-number">{{box.value}}</span>
                  {{else}}
                    <span class="box-number">{{box.value}}</span>
                  {{/if}}
                </div>
                <div class="population-label">{{peoplePopulation box.value}}</div>
              </div>
            {{/each}}
          </div>

          {{!-- Consequences --}}
          <div class="subsection-header">
            {{localize "SCIONS.Faction.Consequences"}}
          </div>
          {{#if system.consequences.minor2.enabled}}
            <div class="consequence-reminder">{{localize "SCIONS.Consequences.ExtraMinorReminder"}}</div>
          {{/if}}

          <div class="consequence-box minor {{#if system.consequences.minor.value}}active{{/if}} {{#if system.consequences.minor.treated}}treated{{/if}}" data-consequence-type="minor">
            <div class="consequence-header">
              <label class="consequence-label">{{localize "SCIONS.Consequences.Minor"}}</label>
              <div class="consequence-status">
                {{#if system.consequences.minor.value}}
                  {{#if system.consequences.minor.treated}}
                    <span class="status-badge treated">{{localize "SCIONS.Consequences.Treated"}}</span>
                  {{else}}
                    <span class="status-badge active">{{localize "SCIONS.Consequences.Active"}}</span>
                  {{/if}}
                {{else}}
                  <span class="status-badge unused">{{localize "SCIONS.Consequences.Unused"}}</span>
                {{/if}}
                <label class="treated-checkbox">
                  <input type="checkbox" name="system.consequences.minor.treated" {{checked system.consequences.minor.treated}} data-dtype="Boolean"/>
                  {{localize "SCIONS.Consequences.MarkTreated"}}
                </label>
                <label class="free-invoke-checkbox">
                  <input type="checkbox" name="system.consequences.minor.freeInvoke" {{checked system.consequences.minor.freeInvoke}} data-dtype="Boolean"/>
                  {{localize "SCIONS.Consequences.FreeInvoke"}}
                </label>
              </div>
            </div>
            <input type="text" name="system.consequences.minor.value" value="{{system.consequences.minor.value}}" placeholder="{{localize 'SCIONS.Consequences.MinorPlaceholder'}}"/>
            <div class="consequence-hint">{{localize "SCIONS.Consequences.MinorHint"}}</div>
          </div>

          {{!-- Minor2 (2) - Optional second minor consequence --}}
          {{#if system.consequences.minor2.enabled}}
            <div class="consequence-box minor {{#if system.consequences.minor2.value}}active{{/if}} {{#if system.consequences.minor2.treated}}treated{{/if}}" data-consequence-type="minor2">
              <div class="consequence-header">
                <label class="consequence-label">{{localize "SCIONS.Consequences.Minor"}}</label>
                <div class="consequence-status">
                  {{#if system.consequences.minor2.value}}
                    {{#if system.consequences.minor2.treated}}
                      <span class="status-badge treated">{{localize "SCIONS.Consequences.Treated"}}</span>
                    {{else}}
                      <span class="status-badge active">{{localize "SCIONS.Consequences.Active"}}</span>
                    {{/if}}
                  {{else}}
                    <span class="status-badge unused">{{localize "SCIONS.Consequences.Unused"}}</span>
                  {{/if}}
                  <label class="treated-checkbox">
                    <input type="checkbox" name="system.consequences.minor2.treated" {{checked system.consequences.minor2.treated}} data-dtype="Boolean"/>
                    {{localize "SCIONS.Consequences.MarkTreated"}}
                  </label>
                  <label class="free-invoke-checkbox">
                    <input type="checkbox" name="system.consequences.minor2.freeInvoke" {{checked system.consequences.minor2.freeInvoke}} data-dtype="Boolean"/>
                    {{localize "SCIONS.Consequences.FreeInvoke"}}
                  </label>
                </div>
              </div>
              <input type="text" name="system.consequences.minor2.value" value="{{system.consequences.minor2.value}}" placeholder="{{localize 'SCIONS.Consequences.MinorPlaceholder'}}"/>
              <div class="consequence-hint">{{localize "SCIONS.Consequences.MinorHint"}}</div>
            </div>
          {{/if}}

          <div class="consequence-box {{#if system.consequences.moderate.value}}active{{/if}} {{#if system.consequences.moderate.treated}}treated{{/if}}" data-consequence-type="moderate">
            <div class="consequence-header">
              <label class="consequence-label">{{localize "SCIONS.Consequences.Moderate"}}</label>
              <div class="consequence-status">
                {{#if system.consequences.moderate.value}}
                  {{#if system.consequences.moderate.treated}}
                    <span class="status-badge treated">{{localize "SCIONS.Consequences.Treated"}}</span>
                  {{else}}
                    <span class="status-badge active">{{localize "SCIONS.Consequences.Active"}}</span>
                  {{/if}}
                {{else}}
                  <span class="status-badge unused">{{localize "SCIONS.Consequences.Unused"}}</span>
                {{/if}}
                <label class="treated-checkbox">
                  <input type="checkbox" name="system.consequences.moderate.treated" {{checked system.consequences.moderate.treated}} data-dtype="Boolean"/>
                  {{localize "SCIONS.Consequences.MarkTreated"}}
                </label>
                <label class="free-invoke-checkbox">
                  <input type="checkbox" name="system.consequences.moderate.freeInvoke" {{checked system.consequences.moderate.freeInvoke}} data-dtype="Boolean"/>
                  {{localize "SCIONS.Consequences.FreeInvoke"}}
                </label>
              </div>
            </div>
            <input type="text" name="system.consequences.moderate.value" value="{{system.consequences.moderate.value}}" placeholder="{{localize 'SCIONS.Consequences.ModeratePlaceholder'}}"/>
            <div class="consequence-hint">{{localize "SCIONS.Consequences.ModerateHint"}}</div>
          </div>

          <div class="consequence-box severe {{#if system.consequences.severe.value}}active{{/if}} {{#if system.consequences.severe.treated}}treated{{/if}}" data-consequence-type="severe">
            <div class="consequence-header">
              <label class="consequence-label">{{localize "SCIONS.Consequences.Severe"}}</label>
              <div class="consequence-status">
                {{#if system.consequences.severe.value}}
                  {{#if system.consequences.severe.treated}}
                    <span class="status-badge treated">{{localize "SCIONS.Consequences.Treated"}}</span>
                  {{else}}
                    <span class="status-badge active">{{localize "SCIONS.Consequences.Active"}}</span>
                  {{/if}}
                {{else}}
                  <span class="status-badge unused">{{localize "SCIONS.Consequences.Unused"}}</span>
                {{/if}}
                <label class="treated-checkbox">
                  <input type="checkbox" name="system.consequences.severe.treated" {{checked system.consequences.severe.treated}} data-dtype="Boolean"/>
                  {{localize "SCIONS.Consequences.MarkTreated"}}
                </label>
                <label class="free-invoke-checkbox">
                  <input type="checkbox" name="system.consequences.severe.freeInvoke" {{checked system.consequences.severe.freeInvoke}} data-dtype="Boolean"/>
                  {{localize "SCIONS.Consequences.FreeInvoke"}}
                </label>
              </div>
            </div>
            <input type="text" name="system.consequences.severe.value" value="{{system.consequences.severe.value}}" placeholder="{{localize 'SCIONS.Consequences.SeverePlaceholder'}}"/>
            <div class="consequence-hint">{{localize "SCIONS.Consequences.SevereHint"}}</div>
          </div>

        </div>

        {{!-- Right Column: Scion --}}
        <div class="column scion-column">
          <div class="section-header">{{localize "SCIONS.Scion.Title"}}</div>

          {{!-- Scion Aspect --}}
          <div class="aspect-box">
            <label>{{localize "SCIONS.Scion.Aspect"}}</label>
            <input type="text" name="system.scion.aspects.scionAspect.value" value="{{system.scion.aspects.scionAspect.value}}" placeholder="{{localize 'SCIONS.Scion.Aspect'}}"/>
          </div>

          {{!-- Skills --}}
          <div class="subsection-header">
            {{localize "SCIONS.Scion.Skills"}}
            {{#unless system.scion.skillValidation.valid}}
              <span class="validation-warning">⚠</span>
            {{/unless}}
          </div>

          <div class="skills-list">
            {{#each system.scion.skills as |skill key|}}
              <div class="skill-item" data-skill="{{key}}" draggable="true" title="Drag to hotbar to create macro">
                <button type="button" class="roll-button roll-skill" data-skill="{{key}}" title="{{localize 'SCIONS.Roll.Roll'}} {{skill.label}}">
                  <i class="fas fa-dice-d6"></i>
                </button>
                <input type="number" class="skill-value {{#if (lookup ../system.scion.skillValidation.invalidSkills key)}}invalid{{/if}}" name="system.scion.skills.{{key}}.value" value="{{skill.value}}" data-dtype="Number" min="-1" max="10"/>
                <span class="skill-label">{{skill.label}}</span>
              </div>
            {{/each}}
          </div>

          {{!-- Skill Validation Warnings --}}
          {{#unless system.scion.skillValidation.valid}}
            <div class="validation-section">
              {{#each system.scion.skillValidation.errors as |error|}}
                <div class="validation-warning">⚠ {{error}}</div>
              {{/each}}
            </div>
          {{/unless}}

          {{!-- Stress Track --}}
          <div class="subsection-header">
            {{localize "SCIONS.Scion.Stress"}}
          </div>
          <div class="stress-track">
            {{#each system.scion.stress.boxes as |box index|}}
              <div class="stress-box {{#if box.value}}checked{{/if}}" data-index="{{index}}" title="{{localize 'SCIONS.Stress.Toggle'}}"></div>
            {{/each}}
          </div>
          {{#if (eq system.scion.stress.max 5)}}
            <div class="stress-reminder">{{localize "SCIONS.Stress.ExtendedReminder"}}</div>
          {{/if}}

          {{!-- Age Track --}}
          <div class="subsection-header">{{localize "SCIONS.Scion.AgeTrack"}}</div>
          <div class="age-track-table">
            <div class="age-track-header">
              <div class="age-track-cell age-header"></div>
              <div class="age-track-cell age-header" title="{{localize 'SCIONS.AgeTrack.WoundHint'}}">{{localize "SCIONS.AgeTrack.Wound"}}</div>
              <div class="age-track-cell age-header" title="{{localize 'SCIONS.AgeTrack.InvokeHint'}}">{{localize "SCIONS.AgeTrack.Invoke"}}</div>
              <div class="age-track-cell age-header" title="{{localize 'SCIONS.AgeTrack.ScarHint'}}">{{localize "SCIONS.AgeTrack.Scar"}}</div>
              <div class="age-track-cell age-header" title="{{localize 'SCIONS.AgeTrack.PassedHint'}}">{{localize "SCIONS.AgeTrack.Passed"}}</div>
            </div>
            {{#each system.scion.ageTrack as |stage key|}}
              <div class="age-track-row">
                <div class="age-track-cell age-label {{#if (eq ../currentAgeStage key)}}current-age{{/if}} {{#if stage.passed}}passed-age{{/if}} {{#if stage.scar}}scarred-age{{/if}}" title="{{stage.ageRange}}">{{stage.label}}</div>
                <div class="age-track-cell age-checkbox wound-cell">
                  <div class="wound-stress-box {{#if stage.wound}}checked{{/if}} {{#if stage.scar}}hidden{{/if}} {{#if stage.passed}}hidden{{/if}}" data-stage="{{key}}" title="{{localize 'SCIONS.AgeTrack.WoundHint'}}"></div>
                </div>
                <div class="age-track-cell age-checkbox">
                  <input type="checkbox" class="age-invoke-used {{#unless stage.wound}}hidden{{/unless}} {{#if stage.scar}}hidden{{/if}} {{#if stage.passed}}hidden{{/if}}" data-stage="{{key}}" {{checked stage.freeInvokeUsed}} title="{{localize 'SCIONS.AgeTrack.InvokeHint'}}"/>
                </div>
                <div class="age-track-cell age-checkbox">
                  <input type="checkbox" class="age-scar {{#if stage.passed}}hidden{{/if}} {{#unless (lookup (lookup ../ageTrackValidation key) 'canCheckScar')}}disabled-checkbox{{/unless}}" data-stage="{{key}}" {{checked stage.scar}} title="{{localize 'SCIONS.AgeTrack.ScarHint'}}"/>
                </div>
                <div class="age-track-cell age-checkbox">
                  <input type="checkbox" class="age-passed {{#if stage.scar}}hidden{{/if}} {{#unless (lookup (lookup ../ageTrackValidation key) 'canCheckPassed')}}disabled-checkbox{{/unless}}" data-stage="{{key}}" {{checked stage.passed}} title="{{localize 'SCIONS.AgeTrack.PassedHint'}}"/>
                </div>
              </div>
            {{/each}}
          </div>

        </div>
      </div>
    </div>

    {{!-- Stunts Tab --}}
    <div class="tab stunts-tab" data-group="primary" data-tab="stunts">
      <div class="section-header">
        {{localize "SCIONS.Faction.Stunts"}} ({{system.faction.stuntCount}})
      </div>
      {{#if (lt system.faction.stuntCount 3)}}
        <div class="validation-warning">⚠ {{localize "SCIONS.Validation.TooFewStunts"}}</div>
      {{/if}}
      {{#unless system.faction.refreshValid}}
        <div class="validation-warning">⚠ {{localize "SCIONS.Validation.TooManyStunts"}}</div>
      {{/unless}}
      {{#if system.faction.multipleConsequenceStunts}}
        <div class="validation-warning">⚠ {{localize "SCIONS.Stunts.MultipleConsequenceStunts"}}</div>
      {{/if}}
      {{#if system.faction.multipleStressStunts}}
        <div class="validation-warning">⚠ {{localize "SCIONS.Stunts.MultipleStressStunts"}}</div>
      {{/if}}

      {{!-- Stunt Items List --}}
      <div class="stunts-list">
        {{#if stuntItems}}
          {{#each stuntItems as |stunt id|}}
            <div class="stunt-item scope-{{stunt.system.scope}}" data-item-id="{{stunt._id}}" draggable="true">
              <div class="stunt-header">
                <img src="{{stunt.img}}" alt="{{stunt.name}}" class="stunt-icon" style="{{#if stunt.system.iconBackground}}background-color: {{stunt.system.iconBackground}};{{/if}}"/>
                <h4 class="stunt-name">{{stunt.name}}</h4>

                {{!-- Roll button for Basic and Swap stunts --}}
                {{#if (eq stunt.type "stunt-basic")}}
                  {{#if (and stunt.system.skillOrCapability stunt.system.actionType)}}
                    <button type="button" class="roll-button roll-stunt" data-item-id="{{stunt._id}}" title="{{localize "SCIONS.Stunts.Roll"}} {{stunt.name}}" style="width: 32px; height: 32px;">
                      <i class="fas fa-dice-d6"></i>
                    </button>
                  {{/if}}
                {{/if}}
                {{#if (eq stunt.type "stunt-swap")}}
                  {{#if (and stunt.system.targetSkillOrCapability stunt.system.replacementSkillOrCapability stunt.system.actionType)}}
                    <button type="button" class="roll-button roll-stunt" data-item-id="{{stunt._id}}" title="{{localize "SCIONS.Stunts.Roll"}} {{stunt.name}}" style="width: 32px; height: 32px;">
                      <i class="fas fa-dice-d6"></i>
                    </button>
                  {{/if}}
                {{/if}}

                <div class="item-controls">
                  <button type="button" class="item-control item-edit" data-item-id="{{stunt._id}}" title="{{localize "SCIONS.Stunts.Edit"}}"><i class="fas fa-edit"></i></button>
                  <button type="button" class="item-control item-delete" data-item-id="{{stunt._id}}" title="{{localize "SCIONS.Stunts.Delete"}}"><i class="fas fa-trash"></i></button>
                </div>
              </div>

              <div class="stunt-content">
                {{!-- Basic Stunt Display --}}
                {{#if (eq stunt.type "stunt-basic")}}
                  {{#if (and stunt.system.skillOrCapability stunt.system.actionType)}}
                    <p>{{localize "SCIONS.Stunts.BecauseIHave"}} <strong>{{stunt.name}}</strong> {{localize "SCIONS.Stunts.IGetPlus2When"}} {{capitalize stunt.system.actionType}} {{localize "SCIONS.Stunts.With"}} {{stunt.system.skillOrCapability}}.{{#if stunt.system.description}} {{{stunt.system.description}}}{{/if}}</p>
                  {{else}}
                    <p><em>{{localize "SCIONS.Stunts.ConfigureStunt"}}</em></p>
                  {{/if}}
                {{/if}}

                {{!-- Swap Stunt Display --}}
                {{#if (eq stunt.type "stunt-swap")}}
                  {{#if (and stunt.system.targetSkillOrCapability stunt.system.replacementSkillOrCapability stunt.system.actionType)}}
                    <p>{{localize "SCIONS.Stunts.BecauseIHave"}} <strong>{{stunt.name}}</strong> {{localize "SCIONS.Stunts.WhenIRoll"}} {{capitalize stunt.system.actionType}} {{localize "SCIONS.Stunts.With"}} {{stunt.system.targetSkillOrCapability}} {{localize "SCIONS.Stunts.ICanUse"}} {{stunt.system.replacementSkillOrCapability}} {{localize "SCIONS.Stunts.Instead"}}.{{#if stunt.system.description}} {{{stunt.system.description}}}{{/if}}</p>
                  {{else}}
                    <p><em>{{localize "SCIONS.Stunts.ConfigureStuntSwap"}}</em></p>
                  {{/if}}
                {{/if}}

                {{!-- Consequence Stunt Display --}}
                {{#if (eq stunt.type "stunt-consequence")}}
                  <p>{{localize "SCIONS.Stunts.BecauseIHave"}} <strong>{{stunt.name}}</strong> {{localize "SCIONS.Stunts.IGetAdditionalMinor"}}{{#if stunt.system.description}} {{{stunt.system.description}}}{{/if}}</p>
                {{/if}}

                {{!-- Stress Stunt Display --}}
                {{#if (eq stunt.type "stunt-stress")}}
                  <p>{{localize "SCIONS.Stunts.BecauseIHave"}} <strong>{{stunt.name}}</strong> {{localize "SCIONS.Stunts.IGetTwoAdditionalStress"}}{{#if stunt.system.description}} {{{stunt.system.description}}}{{/if}}</p>
                {{/if}}

                {{!-- Other Stunt Display --}}
                {{#if (eq stunt.type "stunt-other")}}
                  {{#if stunt.system.description}}
                    {{{stunt.system.description}}}
                  {{else}}
                    <p><em>{{localize "SCIONS.Stunts.AddStuntDescription"}}</em></p>
                  {{/if}}
                {{/if}}
              </div>
            </div>
          {{/each}}
        {{else}}
          <div class="empty-message">{{localize "SCIONS.Stunts.NoStunts"}}</div>
        {{/if}}
      </div>

      {{!-- Add Stunt Buttons --}}
      <div class="add-stunt-buttons">
        <button type="button" class="add-item-button" data-type="stunt-basic">
          <i class="fas fa-plus"></i> Basic Stunt (+2)
        </button>
        <button type="button" class="add-item-button" data-type="stunt-swap">
          <i class="fas fa-plus"></i> Swap Stunt
        </button>
        <button type="button" class="add-item-button" data-type="stunt-consequence">
          <i class="fas fa-plus"></i> Consequence Stunt
        </button>
        <button type="button" class="add-item-button" data-type="stunt-stress">
          <i class="fas fa-plus"></i> Stress Stunt
        </button>
        <button type="button" class="add-item-button" data-type="stunt-other">
          <i class="fas fa-plus"></i> Other Stunt
        </button>
      </div>
    </div>

    {{!-- Extras Tab --}}
    <div class="tab extras-tab" data-group="primary" data-tab="extras">
      <div class="section-header">Extras</div>

      {{!-- Extra Items List --}}
      <div class="extras-list">
        {{#if extraItems}}
          <ol class="items-list">
            {{#each extraItems as |item id|}}
              <li class="item extra-item" data-item-id="{{item._id}}" style="--tint-color: {{item.system.tintColor}};">
                <div class="extra-icon" style="{{#if item.system.iconBackground}}background-color: {{item.system.iconBackground}};{{/if}}">
                  <img src="{{item.img}}" alt="{{item.name}}" title="{{item.name}}"/>
                </div>
                <div class="extra-content">
                  {{#if item.system.aspect}}
                    <div class="extra-aspect-display">
                      <span class="aspect-label">{{item.system.aspectLabel}}:</span>
                      <span class="aspect-value">{{item.system.aspect}}</span>
                    </div>
                  {{/if}}

                  {{!-- Free Invokes --}}
                  {{#if item.system.invokes}}
                    <div class="extra-invokes">
                      {{#each item.system.invokes as |invoke index|}}
                        <input type="checkbox"
                               class="invoke-checkbox"
                               data-item-id="{{item._id}}"
                               data-index="{{index}}"
                               {{checked invoke.spent}}
                               title="{{#if invoke.spent}}{{localize 'SCIONS.Extras.InvokeSpent'}}{{else}}{{localize 'SCIONS.Extras.InvokeAvailable'}}{{/if}}"/>
                      {{/each}}
                    </div>
                  {{/if}}

                  {{!-- Ladder (Extra-Ladder only) --}}
                  {{#if (eq item.type "extra-ladder")}}
                    <div class="extra-ladder-display">
                      <div class="ladder-label">{{item.system.ladderLabel}}</div>
                      <div class="ladder-rungs-vertical">
                        {{#each item.ladderData.rungs as |rung index|}}
                          <div class="ladder-rung-embedded {{#if rung.checked}}checked{{/if}} {{#if rung.isHighestUnchecked}}highest-unchecked{{/if}}">
                            <div class="ladder-rung-value-box ladder-rung-clickable" data-item-id="{{item._id}}" data-index="{{index}}">
                              {{#if (gt item.system.traumaValue 0)}}
                                <span class="rung-value">{{#if rung.checked}}✗{{else}}{{item.system.traumaValue}}{{/if}}</span>
                              {{else}}
                                <span class="rung-value">{{#if rung.checked}}✗{{/if}}</span>
                              {{/if}}
                            </div>
                            <span class="ladder-rung-aspect-embedded {{#if rung.checked}}checked-aspect{{/if}}">{{rung.aspect}}</span>
                          </div>
                        {{/each}}
                      </div>
                    </div>
                  {{/if}}

                  {{!-- Skill (Extra-Skill only) --}}
                  {{#if (eq item.type "extra-skill")}}
                    {{#if item.system.skillName}}
                      <div class="extra-skill-display">
                        <button type="button" class="roll-button roll-extra-skill" data-item-id="{{item._id}}" title="Roll {{item.system.skillName}}">
                          <i class="fas fa-dice-d6"></i>
                        </button>
                        <span class="skill-label">{{item.system.skillName}} {{signedNumber item.system.skillValue}}</span>
                      </div>
                    {{/if}}
                  {{/if}}

                  {{!-- Track (Extra-Track only) --}}
                  {{#if (eq item.type "extra-track")}}
                    <div class="extra-track-display">
                      <div class="track-label">{{item.system.trackLabel}}</div>
                      <div class="track-boxes-compact">
                        {{#each item.system.boxes as |box index|}}
                          <div class="track-box-wrapper {{#if box.checked}}checked{{/if}}"
                               data-item-id="{{item._id}}"
                               data-index="{{index}}"
                               title="Box {{add index 1}}">
                            {{#if (gt item.system.trackValue 0)}}
                              <span class="track-value">{{#if box.checked}}✗{{else}}{{item.system.trackValue}}{{/if}}</span>
                            {{else}}
                              <span class="track-value">{{#if box.checked}}✗{{/if}}</span>
                            {{/if}}
                          </div>
                        {{/each}}
                      </div>
                    </div>
                  {{/if}}

                  {{!-- Growing Track (Extra-Growing-Track only) --}}
                  {{#if (eq item.type "extra-growing-track")}}
                    <div class="extra-track-display">
                      <div class="track-label">{{item.system.trackLabel}}</div>
                      <div class="track-boxes-compact">
                        {{#each item.system.boxes as |box index|}}
                          <div class="track-box-wrapper {{#if box.checked}}checked{{/if}}"
                               data-item-id="{{item._id}}"
                               data-index="{{index}}"
                               title="Box {{add index 1}}">
                            <span class="track-value">{{#if box.checked}}✗{{else}}{{add index 1}}{{/if}}</span>
                          </div>
                        {{/each}}
                      </div>
                    </div>
                  {{/if}}
                </div>

                <div class="item-controls">
                  <a class="item-control item-edit" data-item-id="{{item._id}}" title="{{localize 'SCIONS.Extras.EditExtra'}}"><i class="fas fa-edit"></i></a>
                  <a class="item-control item-delete" data-item-id="{{item._id}}" title="{{localize 'SCIONS.Extras.DeleteExtra'}}"><i class="fas fa-trash"></i></a>
                </div>
              </li>
            {{/each}}
          </ol>
        {{else}}
          <div class="empty-message">
            <p>{{localize "SCIONS.Extras.NoExtras"}}</p>
          </div>
        {{/if}}
      </div>
    </div>

    {{!-- Named NPCs Tab --}}
    <div class="tab npcs-tab" data-group="primary" data-tab="npcs">
      <div class="section-header">Named NPCs</div>

      {{!-- NPC Items List --}}
      <div class="npc-list">
        {{#if npcItems}}
          <ol class="items-list">
            {{#each npcItems as |item id|}}
              <li class="item npc-item flexrow {{#if item.npcData.isDeceased}}deceased{{/if}}" data-item-id="{{item._id}}">
                <div class="item-details">
                  <div class="item-name">
                    <h4>{{item.name}}</h4>
                    {{#if item.system.aspect}}
                      <div class="item-aspect">{{item.system.aspect}}</div>
                    {{/if}}
                  </div>
                  <div class="item-info">
                    <div class="npc-age-status {{#if item.npcData.isDeceased}}deceased{{/if}}">
                      {{#if item.npcData.isDeceased}}
                        Deceased (Gen {{item.npcData.deathGeneration}})
                      {{else}}
                        {{item.npcData.currentAgeLabel}}
                      {{/if}}
                    </div>
                    {{#if item.system.skillName}}
                      <div class="npc-skill-info">
                        <button type="button" class="roll-button roll-npc-skill rollable" title="Roll {{item.system.skillName}}">
                          <i class="fas fa-dice-d6"></i>
                        </button>
                        <span class="skill-label">{{item.system.skillName}} {{signedNumber item.system.skillValue}}</span>
                      </div>
                    {{/if}}
                  </div>
                </div>
                <div class="item-controls">
                  <a class="item-control item-edit" data-item-id="{{item._id}}" title="Edit NPC"><i class="fas fa-edit"></i></a>
                  <a class="item-control item-delete" data-item-id="{{item._id}}" title="Delete NPC"><i class="fas fa-trash"></i></a>
                </div>
              </li>
            {{/each}}
          </ol>
        {{else}}
          <div class="empty-message">
            <p>No NPCs for this faction. Create named NPCs from the Items directory and drag them here.</p>
          </div>
        {{/if}}
      </div>

    </div>

    {{!-- Notes Tab --}}
    <div class="tab notes-tab" data-group="primary" data-tab="notes">
      <div class="section-header">{{localize "SCIONS.Tabs.Notes"}}</div>
      <div class="editor-container">
        {{editor system.notes target="system.notes" button=true owner=owner editable=editable}}
      </div>
    </div>

  </section>

</form>
