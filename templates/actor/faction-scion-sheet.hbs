<form class="{{cssClass}} flexcol" autocomplete="off">

  {{!-- Sheet Header --}}
  <header class="sheet-header">
    <div class="header-fields">
      <div class="name-row">
        <div class="name-field">
          <label class="field-label">{{localize "SCIONS.Faction.FactionName"}}</label>
          <input name="name" type="text" value="{{actor.name}}" placeholder="{{localize 'SCIONS.Faction.FactionName'}}"/>
        </div>
        <div class="name-field">
          <label class="field-label">{{localize "SCIONS.Scion.ScionName"}}</label>
          <input name="system.scion.name" type="text" value="{{system.scion.name}}" placeholder="{{localize 'SCIONS.Scion.ScionName'}}"/>
        </div>
      </div>
      <div class="resource-row">
        <div class="resource refresh-display">
          <label class="resource-label">{{localize "SCIONS.Faction.Refresh"}}</label>
          <div class="refresh-value {{#unless system.faction.refreshValid}}invalid{{/unless}}" title="{{localize 'SCIONS.Faction.RefreshHint'}}">{{system.faction.refresh.value}}</div>
        </div>
        <div class="resource fate-points-display">
          <label class="resource-label">{{localize "SCIONS.Faction.FatePoints"}}</label>
          <div class="fate-point-controls">
            <button type="button" class="fate-points-decrement" title="{{localize 'SCIONS.Actions.Decrease'}}">−</button>
            <input type="number" name="system.faction.fatePoints.value" value="{{system.faction.fatePoints.value}}" data-dtype="Number"/>
            <button type="button" class="fate-points-increment" title="{{localize 'SCIONS.Actions.Increase'}}">+</button>
          </div>
        </div>
        <div class="resource roll-fate-inline">
          <button type="button" class="roll-button roll-fate-header">
            <i class="fas fa-dice"></i> {{localize "SCIONS.Roll.RollFate"}}
          </button>
        </div>
      </div>
      <div class="aspect-row">
        <div class="aspect-box">
          <label>{{localize "SCIONS.Faction.HighConcept"}}</label>
          <input type="text" name="system.aspects.highConcept.value" value="{{system.aspects.highConcept.value}}" placeholder="{{localize 'SCIONS.Faction.HighConcept'}}"/>
        </div>
        <div class="aspect-box">
          <label>{{localize "SCIONS.Faction.Trouble"}}</label>
          <input type="text" name="system.aspects.trouble.value" value="{{system.aspects.trouble.value}}" placeholder="{{localize 'SCIONS.Faction.Trouble'}}"/>
        </div>
      </div>
      {{#unless system.faction.refreshValid}}
        <div class="validation-warning">⚠ {{localize "SCIONS.Validation.RefreshMismatch"}}</div>
      {{/unless}}
    </div>
    <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" height="100" width="100"/>
  </header>

  {{!-- Sheet Tab Navigation --}}
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="main">{{localize "SCIONS.Tabs.Main"}}</a>
    <a class="item" data-tab="stunts">{{localize "SCIONS.Tabs.Stunts"}}</a>
    <a class="item" data-tab="extras">{{localize "SCIONS.Tabs.Extras"}}</a>
    <a class="item" data-tab="notes">{{localize "SCIONS.Tabs.Notes"}}</a>
  </nav>

  {{!-- Sheet Body --}}
  <section class="sheet-body">

    {{!-- Main Tab: Faction and Scion Side by Side --}}
    <div class="tab main-tab" data-group="primary" data-tab="main">
      <div class="two-column-layout">

        {{!-- Left Column: Faction --}}
        <div class="column faction-column">
          <div class="section-header">{{localize "SCIONS.Faction.Title"}}</div>

          {{!-- Inheritance Aspect --}}
          <div class="aspect-box">
            <label>{{localize "SCIONS.Faction.Inheritance"}}</label>
            <input type="text" name="system.faction.aspects.inheritance.value" value="{{system.faction.aspects.inheritance.value}}" placeholder="{{localize 'SCIONS.Faction.Inheritance'}}"/>
          </div>

          {{!-- Capabilities --}}
          <div class="subsection-header">
            {{localize "SCIONS.Faction.Capabilities"}}
            {{#unless capabilityValidation.valid}}
              <span class="validation-warning">⚠</span>
            {{/unless}}
          </div>

          <div class="capabilities-list">
            {{#each system.faction.capabilities as |capability key|}}
              <div class="capability-item">
                <button type="button" class="roll-button roll-capability rollable" data-capability="{{key}}" title="{{localize 'SCIONS.Roll.Roll'}} {{capability.label}}">
                  <i class="fas fa-dice-d6"></i>
                </button>
                <input type="number" class="capability-value {{#if (lookup ../system.faction.capabilityValidation.invalidCapabilities key)}}invalid{{/if}}" name="system.faction.capabilities.{{key}}.value" value="{{capability.value}}" data-dtype="Number" min="-1" max="10"/>
                <span class="capability-label">{{capability.label}}</span>
              </div>
            {{/each}}
          </div>

          {{!-- Capability Validation Warnings --}}
          {{#unless system.faction.capabilityValidation.valid}}
            <div class="validation-section">
              {{#if system.faction.capabilityValidation.totalTooHigh}}
                <div class="validation-warning">⚠ {{localize "SCIONS.Validation.CapabilityTotalTooHigh" total=system.faction.totalCapabilityPoints expected=globals.expectedCapabilityTotal}}</div>
              {{/if}}
              {{#if system.faction.capabilityValidation.totalTooLow}}
                <div class="validation-warning">⚠ {{localize "SCIONS.Validation.CapabilityTotalTooLow" total=system.faction.totalCapabilityPoints expected=globals.expectedCapabilityTotal}}</div>
              {{/if}}
            </div>
          {{/unless}}

          {{!-- People Track --}}
          <div class="subsection-header">{{localize "SCIONS.Faction.PeopleTrack"}}</div>
          <div class="people-track">
            {{#each system.faction.peopleTrack.boxes as |box index|}}
              <div class="people-box-container">
                <div class="box-value-label">{{box.value}}</div>
                <div class="people-box growing {{#if box.committed}}committed{{/if}} {{#if box.expended}}expended{{/if}}"
                     data-index="{{index}}"
                     data-value="{{box.value}}"
                     title="{{localize 'SCIONS.PeopleTrack.ClickInstructions'}}">
                  {{#if box.expended}}
                    <span class="box-number expended-number">{{box.value}}</span>
                  {{else if box.committed}}
                    <span class="box-number">{{box.value}}</span>
                  {{else}}
                    <span class="box-number">{{box.value}}</span>
                  {{/if}}
                </div>
              </div>
            {{/each}}
          </div>
          <div class="track-legend">
            <span>{{localize "SCIONS.PeopleTrack.Legend"}}: {{localize "SCIONS.PeopleTrack.Empty"}} → {{localize "SCIONS.PeopleTrack.Committed"}} → {{localize "SCIONS.PeopleTrack.Expended"}}</span>
          </div>

          {{!-- Consequences --}}
          <div class="subsection-header">{{localize "SCIONS.Faction.Consequences"}}</div>

          <div class="consequence-box minor {{#if system.consequences.minor.value}}active{{/if}} {{#if system.consequences.minor.treated}}treated{{/if}}">
            <div class="consequence-header">
              <label class="consequence-label">{{localize "SCIONS.Consequences.Minor"}}</label>
              <div class="consequence-status">
                {{#if system.consequences.minor.value}}
                  {{#if system.consequences.minor.treated}}
                    <span class="status-badge treated">{{localize "SCIONS.Consequences.Treated"}}</span>
                  {{else}}
                    <span class="status-badge active">{{localize "SCIONS.Consequences.Active"}}</span>
                  {{/if}}
                {{else}}
                  <span class="status-badge unused">{{localize "SCIONS.Consequences.Unused"}}</span>
                {{/if}}
                <label class="treated-checkbox">
                  <input type="checkbox" name="system.consequences.minor.treated" {{checked system.consequences.minor.treated}}/>
                  {{localize "SCIONS.Consequences.MarkTreated"}}
                </label>
              </div>
            </div>
            <input type="text" name="system.consequences.minor.value" value="{{system.consequences.minor.value}}" placeholder="{{localize 'SCIONS.Consequences.MinorPlaceholder'}}"/>
            <div class="consequence-hint">{{localize "SCIONS.Consequences.MinorHint"}}</div>
          </div>

          <div class="consequence-box {{#if system.consequences.moderate.value}}active{{/if}} {{#if system.consequences.moderate.treated}}treated{{/if}}">
            <div class="consequence-header">
              <label class="consequence-label">{{localize "SCIONS.Consequences.Moderate"}}</label>
              <div class="consequence-status">
                {{#if system.consequences.moderate.value}}
                  {{#if system.consequences.moderate.treated}}
                    <span class="status-badge treated">{{localize "SCIONS.Consequences.Treated"}}</span>
                  {{else}}
                    <span class="status-badge active">{{localize "SCIONS.Consequences.Active"}}</span>
                  {{/if}}
                {{else}}
                  <span class="status-badge unused">{{localize "SCIONS.Consequences.Unused"}}</span>
                {{/if}}
                <label class="treated-checkbox">
                  <input type="checkbox" name="system.consequences.moderate.treated" {{checked system.consequences.moderate.treated}}/>
                  {{localize "SCIONS.Consequences.MarkTreated"}}
                </label>
              </div>
            </div>
            <input type="text" name="system.consequences.moderate.value" value="{{system.consequences.moderate.value}}" placeholder="{{localize 'SCIONS.Consequences.ModeratePlaceholder'}}"/>
            <div class="consequence-hint">{{localize "SCIONS.Consequences.ModerateHint"}}</div>
          </div>

          <div class="consequence-box severe {{#if system.consequences.severe.value}}active{{/if}} {{#if system.consequences.severe.treated}}treated{{/if}}">
            <div class="consequence-header">
              <label class="consequence-label">{{localize "SCIONS.Consequences.Severe"}}</label>
              <div class="consequence-status">
                {{#if system.consequences.severe.value}}
                  {{#if system.consequences.severe.treated}}
                    <span class="status-badge treated">{{localize "SCIONS.Consequences.Treated"}}</span>
                  {{else}}
                    <span class="status-badge active">{{localize "SCIONS.Consequences.Active"}}</span>
                  {{/if}}
                {{else}}
                  <span class="status-badge unused">{{localize "SCIONS.Consequences.Unused"}}</span>
                {{/if}}
                <label class="treated-checkbox">
                  <input type="checkbox" name="system.consequences.severe.treated" {{checked system.consequences.severe.treated}}/>
                  {{localize "SCIONS.Consequences.MarkTreated"}}
                </label>
              </div>
            </div>
            <input type="text" name="system.consequences.severe.value" value="{{system.consequences.severe.value}}" placeholder="{{localize 'SCIONS.Consequences.SeverePlaceholder'}}"/>
            <div class="consequence-hint">{{localize "SCIONS.Consequences.SevereHint"}}</div>
          </div>

        </div>

        {{!-- Right Column: Scion --}}
        <div class="column scion-column">
          <div class="section-header">{{localize "SCIONS.Scion.Title"}}</div>

          {{!-- Scion Aspect --}}
          <div class="aspect-box">
            <label>{{localize "SCIONS.Scion.Aspect"}}</label>
            <input type="text" name="system.scion.aspects.scionAspect.value" value="{{system.scion.aspects.scionAspect.value}}" placeholder="{{localize 'SCIONS.Scion.Aspect'}}"/>
          </div>

          {{!-- Skills --}}
          <div class="subsection-header">
            {{localize "SCIONS.Scion.Skills"}}
            {{#unless system.scion.skillValidation.valid}}
              <span class="validation-warning">⚠</span>
            {{/unless}}
          </div>

          <div class="skills-list">
            {{#each system.scion.skills as |skill key|}}
              <div class="skill-item">
                <button type="button" class="roll-button roll-skill rollable" data-skill="{{key}}" title="{{localize 'SCIONS.Roll.Roll'}} {{skill.label}}">
                  <i class="fas fa-dice-d6"></i>
                </button>
                <input type="number" class="skill-value {{#if (lookup ../system.scion.skillValidation.invalidSkills key)}}invalid{{/if}}" name="system.scion.skills.{{key}}.value" value="{{skill.value}}" data-dtype="Number" min="-1" max="10"/>
                <span class="skill-label">{{skill.label}}</span>
              </div>
            {{/each}}
          </div>

          {{!-- Skill Validation Warnings --}}
          {{#unless system.scion.skillValidation.valid}}
            <div class="validation-section">
              {{#if system.scion.skillValidation.totalTooHigh}}
                <div class="validation-warning">⚠ {{localize "SCIONS.Validation.SkillTotalTooHigh" total=system.scion.totalSkillPoints expected=system.scion.expectedSkillTotal}}</div>
              {{/if}}
              {{#if system.scion.skillValidation.totalTooLow}}
                <div class="validation-warning">⚠ {{localize "SCIONS.Validation.SkillTotalTooLow" total=system.scion.totalSkillPoints expected=system.scion.expectedSkillTotal}}</div>
              {{/if}}
            </div>
          {{/unless}}

          {{!-- Stress Track --}}
          <div class="subsection-header">
            {{localize "SCIONS.Scion.Stress"}}
            <span class="stress-size-toggle" title="{{localize 'SCIONS.Stress.SizeHint'}}">
              <i class="fas fa-cog stress-size-icon {{#if (eq system.scion.stress.max 5)}}extended{{/if}}"></i>
              <span class="stress-size-label">{{localize "SCIONS.Stress.Extended"}}</span>
            </span>
          </div>
          <div class="stress-track">
            {{#each system.scion.stress.boxes as |box index|}}
              <div class="stress-box {{#if box.value}}checked{{/if}}" data-index="{{index}}" title="{{localize 'SCIONS.Stress.Toggle'}}"></div>
            {{/each}}
          </div>
          {{#if (eq system.scion.stress.max 5)}}
            <div class="stress-reminder">{{localize "SCIONS.Stress.ExtendedReminder"}}</div>
          {{/if}}

          {{!-- Age Track --}}
          <div class="subsection-header">{{localize "SCIONS.Scion.AgeTrack"}}</div>
          <div class="age-track-table">
            <div class="age-track-header">
              <div class="age-track-cell age-header"></div>
              <div class="age-track-cell age-header" title="{{localize 'SCIONS.AgeTrack.WoundHint'}}">{{localize "SCIONS.AgeTrack.Wound"}}</div>
              <div class="age-track-cell age-header" title="{{localize 'SCIONS.AgeTrack.InvokeHint'}}">{{localize "SCIONS.AgeTrack.Invoke"}}</div>
              <div class="age-track-cell age-header" title="{{localize 'SCIONS.AgeTrack.ScarHint'}}">{{localize "SCIONS.AgeTrack.Scar"}}</div>
              <div class="age-track-cell age-header" title="{{localize 'SCIONS.AgeTrack.PassedHint'}}">{{localize "SCIONS.AgeTrack.Passed"}}</div>
            </div>
            {{#each system.scion.ageTrack as |stage key|}}
              <div class="age-track-row">
                <div class="age-track-cell age-label {{#if (eq ../currentAgeStage key)}}current-age{{/if}} {{#if stage.passed}}passed-age{{/if}} {{#if stage.scar}}scarred-age{{/if}}" title="{{stage.ageRange}}">{{stage.label}}</div>
                <div class="age-track-cell age-checkbox wound-cell">
                  <div class="wound-stress-box {{#if stage.wound}}checked{{/if}} {{#if stage.scar}}hidden{{/if}} {{#if stage.passed}}hidden{{/if}}" data-stage="{{key}}" title="{{localize 'SCIONS.AgeTrack.WoundHint'}}"></div>
                </div>
                <div class="age-track-cell age-checkbox">
                  <input type="checkbox" class="age-invoke-used {{#unless stage.wound}}hidden{{/unless}} {{#if stage.scar}}hidden{{/if}} {{#if stage.passed}}hidden{{/if}}" data-stage="{{key}}" {{checked stage.freeInvokeUsed}} title="{{localize 'SCIONS.AgeTrack.InvokeHint'}}"/>
                </div>
                <div class="age-track-cell age-checkbox">
                  <input type="checkbox" class="age-scar {{#if stage.passed}}hidden{{/if}} {{#unless (lookup (lookup ../ageTrackValidation key) 'canCheckScar')}}disabled-checkbox{{/unless}}" data-stage="{{key}}" {{checked stage.scar}} title="{{localize 'SCIONS.AgeTrack.ScarHint'}}"/>
                </div>
                <div class="age-track-cell age-checkbox">
                  <input type="checkbox" class="age-passed {{#if stage.scar}}hidden{{/if}} {{#unless (lookup (lookup ../ageTrackValidation key) 'canCheckPassed')}}disabled-checkbox{{/unless}}" data-stage="{{key}}" {{checked stage.passed}} title="{{localize 'SCIONS.AgeTrack.PassedHint'}}"/>
                </div>
              </div>
            {{/each}}
          </div>

        </div>
      </div>
    </div>

    {{!-- Stunts Tab --}}
    <div class="tab stunts-tab" data-group="primary" data-tab="stunts">
      <div class="section-header">
        {{localize "SCIONS.Faction.Stunts"}} ({{system.faction.stuntCount}})
      </div>
      {{#if (lt system.faction.stuntCount 3)}}
        <div class="validation-warning">⚠ {{localize "SCIONS.Validation.TooFewStunts"}}</div>
      {{/if}}
      {{#unless system.faction.refreshValid}}
        <div class="validation-warning">⚠ {{localize "SCIONS.Validation.TooManyStunts"}}</div>
      {{/unless}}

      {{#each system.faction.stunts as |stunt index|}}
        <div class="stunt-item">
          <div class="stunt-header">
            <input type="text" class="stunt-name" name="system.faction.stunts.{{index}}.name" value="{{stunt.name}}" placeholder="{{localize 'SCIONS.Stunts.NamePlaceholder'}}"/>
            <button type="button" class="stunt-delete" data-index="{{index}}" title="{{localize 'SCIONS.Actions.Delete'}}"><i class="fas fa-trash"></i></button>
          </div>
          <div class="stunt-description">
            {{editor stunt.description target=(concat "system.faction.stunts." index ".description") button=true owner=owner editable=editable}}
          </div>
        </div>
      {{/each}}

      <button type="button" class="add-item-button stunt-add">
        <i class="fas fa-plus"></i> {{localize "SCIONS.Actions.AddStunt"}}
      </button>
    </div>

    {{!-- Extras Tab --}}
    <div class="tab extras-tab" data-group="primary" data-tab="extras">
      <div class="section-header">{{localize "SCIONS.Faction.Extras"}}</div>

      {{#each system.faction.extras as |extra index|}}
        <div class="extra-item">
          <div class="extra-header">
            <input type="text" class="extra-name" name="system.faction.extras.{{index}}.name" value="{{extra.name}}" placeholder="{{localize 'SCIONS.Extras.NamePlaceholder'}}"/>
            <button type="button" class="extra-delete" data-index="{{index}}" title="{{localize 'SCIONS.Actions.Delete'}}"><i class="fas fa-trash"></i></button>
          </div>
          <div class="extra-description">
            {{editor extra.description target=(concat "system.faction.extras." index ".description") button=true owner=owner editable=editable}}
          </div>
        </div>
      {{/each}}

      <button type="button" class="add-item-button extra-add">
        <i class="fas fa-plus"></i> {{localize "SCIONS.Actions.AddExtra"}}
      </button>
    </div>

    {{!-- Notes Tab --}}
    <div class="tab notes-tab" data-group="primary" data-tab="notes">
      <div class="section-header">{{localize "SCIONS.Tabs.Notes"}}</div>
      <div class="editor-container">
        {{editor system.notes target="system.notes" button=true owner=owner editable=editable}}
      </div>
    </div>

  </section>

</form>
