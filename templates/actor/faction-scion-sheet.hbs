<form class="{{cssClass}} flexcol" autocomplete="off">

  {{!-- Sheet Header --}}
  <header class="sheet-header">
    <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" height="100" width="100"/>
    <div class="header-fields">
      <div class="name-row">
        <div class="name-field">
          <label class="field-label">{{localize "SCIONS.Faction.FactionName"}}</label>
          <input name="name" type="text" value="{{actor.name}}" placeholder="{{localize 'SCIONS.Faction.FactionName'}}"/>
        </div>
        <div class="name-field">
          <label class="field-label">{{localize "SCIONS.Scion.ScionName"}}</label>
          <input name="system.scion.name" type="text" value="{{system.scion.name}}" placeholder="{{localize 'SCIONS.Scion.ScionName'}}"/>
        </div>
      </div>
      <div class="resource-row">
        <div class="resource">
          <label class="resource-label">{{localize "SCIONS.Faction.Refresh"}}</label>
          <input type="number" name="system.faction.refresh.value" value="{{system.faction.refresh.value}}" data-dtype="Number"/>
        </div>
        <div class="resource fate-points-display">
          <label class="resource-label">{{localize "SCIONS.Faction.FatePoints"}}</label>
          <div class="fate-point-controls">
            <button type="button" class="fate-points-decrement" title="{{localize 'SCIONS.Actions.Decrease'}}">−</button>
            <input type="number" name="system.faction.fatePoints.value" value="{{system.faction.fatePoints.value}}" data-dtype="Number"/>
            <button type="button" class="fate-points-increment" title="{{localize 'SCIONS.Actions.Increase'}}">+</button>
          </div>
        </div>
        <div class="resource roll-fate-container">
          <button type="button" class="roll-button roll-fate-header">
            <i class="fas fa-dice"></i> {{localize "SCIONS.Roll.RollFate"}}
          </button>
        </div>
      </div>
      {{#unless system.faction.refreshValid}}
        <div class="validation-warning">⚠ {{localize "SCIONS.Validation.RefreshMismatch"}}</div>
      {{/unless}}
    </div>
  </header>

  {{!-- Sheet Tab Navigation --}}
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="main">{{localize "SCIONS.Tabs.Main"}}</a>
    <a class="item" data-tab="stunts">{{localize "SCIONS.Tabs.Stunts"}}</a>
    <a class="item" data-tab="extras">{{localize "SCIONS.Tabs.Extras"}}</a>
    <a class="item" data-tab="notes">{{localize "SCIONS.Tabs.Notes"}}</a>
  </nav>

  {{!-- Sheet Body --}}
  <section class="sheet-body">

    {{!-- Main Tab: Faction and Scion Side by Side --}}
    <div class="tab main-tab" data-group="primary" data-tab="main">
      <div class="two-column-layout">

        {{!-- Left Column: Faction --}}
        <div class="column faction-column">
          <div class="section-header">{{localize "SCIONS.Faction.Title"}}</div>

          {{!-- Faction Aspects --}}
          <div class="aspect-box">
            <label>{{localize "SCIONS.Faction.HighConcept"}}</label>
            <input type="text" name="system.aspects.highConcept.value" value="{{system.aspects.highConcept.value}}" placeholder="{{localize 'SCIONS.Faction.HighConcept'}}"/>
          </div>

          <div class="aspect-box">
            <label>{{localize "SCIONS.Faction.Trouble"}}</label>
            <input type="text" name="system.aspects.trouble.value" value="{{system.aspects.trouble.value}}" placeholder="{{localize 'SCIONS.Faction.Trouble'}}"/>
          </div>

          <div class="aspect-box">
            <label>{{localize "SCIONS.Faction.Inheritance"}}</label>
            <input type="text" name="system.faction.aspects.inheritance.value" value="{{system.faction.aspects.inheritance.value}}" placeholder="{{localize 'SCIONS.Faction.Inheritance'}}"/>
          </div>

          {{!-- Capabilities --}}
          <div class="subsection-header">
            {{localize "SCIONS.Faction.Capabilities"}}
            {{#unless capabilityValidation.valid}}
              <span class="validation-warning">⚠</span>
            {{/unless}}
          </div>

          <div class="capabilities-list">
            {{#each system.faction.capabilities as |capability key|}}
              <div class="capability-item">
                <span class="capability-label">{{capability.label}}</span>
                <input type="number" class="capability-value" name="system.faction.capabilities.{{key}}.value" value="{{capability.value}}" data-dtype="Number" min="-1" max="10"/>
                <button type="button" class="roll-button roll-capability rollable" data-capability="{{key}}" title="{{localize 'SCIONS.Roll.Roll'}} {{capability.label}}">
                  <i class="fas fa-dice-d6"></i>
                </button>
              </div>
            {{/each}}
          </div>

          {{!-- People Track --}}
          <div class="subsection-header">{{localize "SCIONS.Faction.PeopleTrack"}}</div>
          <div class="people-track">
            {{#each system.faction.peopleTrack.boxes as |box index|}}
              <div class="people-box-container">
                <div class="box-value-label">{{box.value}}</div>
                <div class="stress-box growing people-box {{#if box.committed}}committed{{/if}} {{#if box.expended}}expended{{/if}}"
                     data-index="{{index}}"
                     data-value="{{box.value}}"
                     title="{{localize 'SCIONS.PeopleTrack.ClickInstructions'}}">
                  {{#if box.expended}}
                    <span class="box-mark">✖</span>
                  {{else if box.committed}}
                    <span class="box-mark">◐</span>
                  {{else}}
                    <span class="box-number">{{box.value}}</span>
                  {{/if}}
                </div>
              </div>
            {{/each}}
          </div>
          <div class="track-legend">
            <span>{{localize "SCIONS.PeopleTrack.Legend"}}: {{localize "SCIONS.PeopleTrack.Empty"}} → {{localize "SCIONS.PeopleTrack.Committed"}} → {{localize "SCIONS.PeopleTrack.Expended"}}</span>
          </div>

          {{!-- Consequences --}}
          <div class="subsection-header">{{localize "SCIONS.Faction.Consequences"}}</div>

          <div class="consequence-box {{#if system.consequences.minor.value}}active{{/if}} {{#if system.consequences.minor.treated}}treated{{/if}}">
            <div class="consequence-header">
              <label class="consequence-label">{{localize "SCIONS.Consequences.Minor"}}</label>
              <div class="consequence-status">
                {{#if system.consequences.minor.value}}
                  {{#if system.consequences.minor.treated}}
                    <span class="status-badge treated">{{localize "SCIONS.Consequences.Treated"}}</span>
                  {{else}}
                    <span class="status-badge active">{{localize "SCIONS.Consequences.Active"}}</span>
                  {{/if}}
                {{else}}
                  <span class="status-badge unused">{{localize "SCIONS.Consequences.Unused"}}</span>
                {{/if}}
                <label class="treated-checkbox">
                  <input type="checkbox" name="system.consequences.minor.treated" {{checked system.consequences.minor.treated}}/>
                  {{localize "SCIONS.Consequences.MarkTreated"}}
                </label>
              </div>
            </div>
            <input type="text" name="system.consequences.minor.value" value="{{system.consequences.minor.value}}" placeholder="{{localize 'SCIONS.Consequences.MinorPlaceholder'}}"/>
          </div>

          <div class="consequence-box {{#if system.consequences.moderate.value}}active{{/if}} {{#if system.consequences.moderate.treated}}treated{{/if}}">
            <div class="consequence-header">
              <label class="consequence-label">{{localize "SCIONS.Consequences.Moderate"}}</label>
              <div class="consequence-status">
                {{#if system.consequences.moderate.value}}
                  {{#if system.consequences.moderate.treated}}
                    <span class="status-badge treated">{{localize "SCIONS.Consequences.Treated"}}</span>
                  {{else}}
                    <span class="status-badge active">{{localize "SCIONS.Consequences.Active"}}</span>
                  {{/if}}
                {{else}}
                  <span class="status-badge unused">{{localize "SCIONS.Consequences.Unused"}}</span>
                {{/if}}
                <label class="treated-checkbox">
                  <input type="checkbox" name="system.consequences.moderate.treated" {{checked system.consequences.moderate.treated}}/>
                  {{localize "SCIONS.Consequences.MarkTreated"}}
                </label>
              </div>
            </div>
            <input type="text" name="system.consequences.moderate.value" value="{{system.consequences.moderate.value}}" placeholder="{{localize 'SCIONS.Consequences.ModeratePlaceholder'}}"/>
          </div>

          <div class="consequence-box severe {{#if system.consequences.severe.value}}active{{/if}} {{#if system.consequences.severe.treated}}treated{{/if}}">
            <div class="consequence-header">
              <label class="consequence-label">{{localize "SCIONS.Consequences.Severe"}}</label>
              <div class="consequence-status">
                {{#if system.consequences.severe.value}}
                  {{#if system.consequences.severe.treated}}
                    <span class="status-badge treated">{{localize "SCIONS.Consequences.Treated"}}</span>
                  {{else}}
                    <span class="status-badge active">{{localize "SCIONS.Consequences.Active"}}</span>
                  {{/if}}
                {{else}}
                  <span class="status-badge unused">{{localize "SCIONS.Consequences.Unused"}}</span>
                {{/if}}
                <label class="treated-checkbox">
                  <input type="checkbox" name="system.consequences.severe.treated" {{checked system.consequences.severe.treated}}/>
                  {{localize "SCIONS.Consequences.MarkTreated"}}
                </label>
              </div>
            </div>
            <input type="text" name="system.consequences.severe.value" value="{{system.consequences.severe.value}}" placeholder="{{localize 'SCIONS.Consequences.SeverePlaceholder'}}"/>
          </div>

        </div>

        {{!-- Right Column: Scion --}}
        <div class="column scion-column">
          <div class="section-header">{{localize "SCIONS.Scion.Title"}}</div>

          {{!-- Scion Aspect --}}
          <div class="aspect-box">
            <label>{{localize "SCIONS.Scion.Aspect"}}</label>
            <input type="text" name="system.scion.aspects.scionAspect.value" value="{{system.scion.aspects.scionAspect.value}}" placeholder="{{localize 'SCIONS.Scion.Aspect'}}"/>
          </div>

          {{!-- Skills --}}
          <div class="subsection-header">
            {{localize "SCIONS.Scion.Skills"}}
            {{#unless skillValidation.valid}}
              <span class="validation-warning">⚠</span>
            {{/unless}}
          </div>

          <div class="skills-list">
            {{#each system.scion.skills as |skill key|}}
              <div class="skill-item">
                <span class="skill-label">{{skill.label}}</span>
                <input type="number" class="skill-value" name="system.scion.skills.{{key}}.value" value="{{skill.value}}" data-dtype="Number" min="-1" max="10"/>
                <button type="button" class="roll-button roll-skill rollable" data-skill="{{key}}" title="{{localize 'SCIONS.Roll.Roll'}} {{skill.label}}">
                  <i class="fas fa-dice-d6"></i>
                </button>
              </div>
            {{/each}}
          </div>

          {{!-- Stress Track --}}
          <div class="subsection-header">{{localize "SCIONS.Scion.Stress"}}</div>
          <div class="stress-track">
            {{#each system.scion.stress.boxes as |box index|}}
              <div class="stress-box {{#if box.value}}checked{{/if}}" data-index="{{index}}" title="{{localize 'SCIONS.Stress.Toggle'}}"></div>
            {{/each}}
          </div>

          {{!-- Age Track --}}
          <div class="subsection-header">{{localize "SCIONS.Scion.AgeTrack"}}</div>
          <div class="age-track">
            {{#each system.scion.ageTrack as |stage key|}}
              <div class="age-stage">
                <div class="age-stage-label">{{stage.label}}</div>
                <div class="age-stage-checks">
                  <label title="{{localize 'SCIONS.AgeTrack.PassedHint'}}">
                    <input type="checkbox" class="age-passed" data-stage="{{key}}" {{checked stage.passed}}/>
                    {{localize "SCIONS.AgeTrack.Passed"}}
                  </label>
                  <label title="{{localize 'SCIONS.AgeTrack.WoundHint'}}">
                    <input type="checkbox" class="age-wound" data-stage="{{key}}" {{checked stage.wound}}/>
                    {{localize "SCIONS.AgeTrack.Wound"}}
                  </label>
                  <label title="{{localize 'SCIONS.AgeTrack.UsedHint'}}">
                    <input type="checkbox" class="age-invoke-used" data-stage="{{key}}" {{checked stage.freeInvokeUsed}}/>
                    {{localize "SCIONS.AgeTrack.Used"}}
                  </label>
                  <label title="{{localize 'SCIONS.AgeTrack.ScarHint'}}">
                    <input type="checkbox" class="age-scar" data-stage="{{key}}" {{checked stage.scar}}/>
                    {{localize "SCIONS.AgeTrack.Scar"}}
                  </label>
                </div>
              </div>
            {{/each}}
          </div>

        </div>
      </div>
    </div>

    {{!-- Stunts Tab --}}
    <div class="tab stunts-tab" data-group="primary" data-tab="stunts">
      <div class="section-header">
        {{localize "SCIONS.Faction.Stunts"}} ({{system.faction.stuntCount}})
      </div>

      {{#each system.faction.stunts as |stunt index|}}
        <div class="stunt-item">
          <div class="stunt-header">
            <input type="text" class="stunt-name" name="system.faction.stunts.{{index}}.name" value="{{stunt.name}}" placeholder="{{localize 'SCIONS.Stunts.NamePlaceholder'}}"/>
            <button type="button" class="stunt-delete" data-index="{{index}}" title="{{localize 'SCIONS.Actions.Delete'}}"><i class="fas fa-trash"></i></button>
          </div>
          <textarea name="system.faction.stunts.{{index}}.description" rows="3" placeholder="{{localize 'SCIONS.Stunts.DescriptionPlaceholder'}}">{{stunt.description}}</textarea>
        </div>
      {{/each}}

      <button type="button" class="add-item-button stunt-add">
        <i class="fas fa-plus"></i> {{localize "SCIONS.Actions.AddStunt"}}
      </button>
    </div>

    {{!-- Extras Tab --}}
    <div class="tab extras-tab" data-group="primary" data-tab="extras">
      <div class="section-header">{{localize "SCIONS.Faction.Extras"}}</div>

      {{#each system.faction.extras as |extra index|}}
        <div class="extra-item">
          <div class="extra-header">
            <input type="text" class="extra-name" name="system.faction.extras.{{index}}.name" value="{{extra.name}}" placeholder="{{localize 'SCIONS.Extras.NamePlaceholder'}}"/>
            <button type="button" class="extra-delete" data-index="{{index}}" title="{{localize 'SCIONS.Actions.Delete'}}"><i class="fas fa-trash"></i></button>
          </div>
          <textarea name="system.faction.extras.{{index}}.description" rows="3" placeholder="{{localize 'SCIONS.Extras.DescriptionPlaceholder'}}">{{extra.description}}</textarea>
        </div>
      {{/each}}

      <button type="button" class="add-item-button extra-add">
        <i class="fas fa-plus"></i> {{localize "SCIONS.Actions.AddExtra"}}
      </button>
    </div>

    {{!-- Notes Tab --}}
    <div class="tab notes-tab" data-group="primary" data-tab="notes">
      <div class="section-header">{{localize "SCIONS.Tabs.Notes"}}</div>
      <div class="editor-container">
        {{editor system.notes target="system.notes" button=true owner=owner editable=editable}}
      </div>
    </div>

  </section>

</form>
