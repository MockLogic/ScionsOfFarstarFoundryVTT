<form class="{{cssClass}} flexcol" autocomplete="off">

  {{!-- Sheet Header --}}
  <header class="sheet-header">
    <div class="header-fields">
      <div class="field-group colony-name-field">
        <label>{{localize "SCIONS.Colony.ColonyName"}}</label>
        <input type="text" name="name" value="{{actor.name}}" placeholder="{{localize 'SCIONS.Colony.ColonyNamePlaceholder'}}"/>
      </div>
    </div>
  </header>

  {{!-- Aspects Section (Always Visible) --}}
  <div class="aspects-section colony-aspects">
    <div class="aspect-field">
      <label>{{localize "SCIONS.Aspects.HighConcept"}}</label>
      <input type="text" name="system.aspects.highConcept.value" value="{{system.aspects.highConcept.value}}" placeholder="{{localize 'SCIONS.Aspects.HighConceptPlaceholder'}}"/>
    </div>

    <div class="aspect-field">
      <label>{{localize "SCIONS.Aspects.Trouble"}}</label>
      <input type="text" name="system.aspects.trouble.value" value="{{system.aspects.trouble.value}}" placeholder="{{localize 'SCIONS.Aspects.TroublePlaceholder'}}"/>
    </div>
  </div>

  {{!-- Sheet Tab Navigation --}}
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="main">{{localize "SCIONS.Tabs.Main"}}</a>
    <a class="item" data-tab="extras">{{localize "SCIONS.Tabs.Extras"}}</a>
    <a class="item" data-tab="npcs">Named NPCs</a>
    <a class="item" data-tab="notes">{{localize "SCIONS.Tabs.Notes"}}</a>
  </nav>

  {{!-- Sheet Body --}}
  <section class="sheet-body">

    {{!-- Main Tab --}}
    <div class="tab main-tab" data-group="primary" data-tab="main">

    {{!-- Attributes Pyramid --}}
    <div class="attributes-section">
      <div class="section-header">{{localize "SCIONS.Colony.Attributes"}}</div>

      {{!-- Point Total Display --}}
      <div class="attribute-total-display">
        <span>Total Points: {{system.attributeValidation.totalPoints}} / {{system.attributeValidation.expectedTotal}}</span>
      </div>

      {{!-- Validation Errors (Column violations) --}}
      {{#unless system.attributeValidation.valid}}
        <div class="validation-warning error">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Attribute Column Validation Issues:</strong>
          <ul>
            {{#each system.attributeValidation.errors as |error|}}
              <li>{{error}}</li>
            {{/each}}
          </ul>
        </div>
      {{/unless}}

      {{!-- Point Total Warnings --}}
      {{#if system.attributeValidation.warnings}}
        {{#each system.attributeValidation.warnings as |warning|}}
          <div class="validation-warning {{warning.type}}">
            <i class="fas {{#if (eq warning.type 'low')}}fa-arrow-down{{else}}fa-arrow-up{{/if}}"></i>
            <span>{{warning.message}}</span>
          </div>
        {{/each}}
      {{/if}}

      <div class="attributes-pyramid">
        {{!-- Display ranks from 6 down to 0 --}}
        {{#each (reverse (array 0 1 2 3 4 5 6)) as |rank|}}
          <div class="attribute-rank {{#if (lookup ../system.attributeValidation.invalidRanks rank)}}invalid{{/if}}" data-rank="{{rank}}">
            <div class="rank-label">+{{rank}}</div>
            <div class="rank-attributes">
              {{#each (lookup ../attributesByRank rank) as |attr|}}
                <div class="attribute-item" data-index="{{attr.index}}" draggable="true">
                  <button type="button" class="roll-button roll-attribute" title="{{localize 'SCIONS.Actions.Roll'}}">
                    <i class="fas fa-dice-d6"></i>
                  </button>
                  <input type="text"
                         class="attribute-name {{#if attr.locked}}locked{{/if}}"
                         value="{{attr.name}}"
                         {{#if attr.locked}}readonly{{/if}}
                         placeholder="{{#if attr.locked}}{{else}}Enter attribute name{{/if}}"/>
                  {{#if attr.locked}}
                    <div class="lock-indicator" title="{{localize 'SCIONS.Colony.LockedAttribute'}}">
                      <i class="fas fa-lock"></i>
                    </div>
                  {{else}}
                    <button type="button" class="delete-attribute" title="{{localize 'SCIONS.Actions.Delete'}}">
                      <i class="fas fa-times"></i>
                    </button>
                  {{/if}}
                </div>
              {{/each}}
              {{!-- Add attribute button in rank 0 --}}
              {{#if (eq rank 0)}}
                <button type="button" class="add-attribute" title="{{localize 'SCIONS.Colony.AddAttribute'}}">
                  <i class="fas fa-plus"></i> {{localize "SCIONS.Colony.AddAttribute"}}
                </button>
              {{/if}}
            </div>
            {{#if (gt rank 0)}}
              <div class="rank-count">({{lookup ../rankCounts rank}})</div>
            {{/if}}
          </div>
        {{/each}}
      </div>
    </div>

    {{!-- Population Track --}}
    <div class="population-track-section">
      <div class="section-header">
        {{localize "SCIONS.Colony.PopulationTrack"}}
        <span class="track-legend">{{localize "SCIONS.PopulationTrack.Legend"}}: {{localize "SCIONS.PopulationTrack.Ok"}} → {{localize "SCIONS.PopulationTrack.Expended"}}</span>
      </div>
      <div class="population-track">
        {{#each system.populationTrack.boxes as |box index|}}
          <div class="population-box-container">
            <div class="population-box {{#if box.expended}}expended{{/if}}"
                 data-index="{{index}}">
              <span class="box-number">{{box.value}}</span>
            </div>
            <div class="population-scale">
              {{#if (eq box.value 1)}}{{localize "SCIONS.PopulationTrack.Thousands"}}
              {{else if (eq box.value 2)}}{{localize "SCIONS.PopulationTrack.TensOfThousands"}}
              {{else if (eq box.value 3)}}{{localize "SCIONS.PopulationTrack.HundredsOfThousands"}}
              {{else if (eq box.value 4)}}{{localize "SCIONS.PopulationTrack.Millions"}}
              {{else if (eq box.value 5)}}{{localize "SCIONS.PopulationTrack.TensOfMillions"}}
              {{else if (eq box.value 6)}}{{localize "SCIONS.PopulationTrack.HundredsOfMillions"}}
              {{/if}}
            </div>
          </div>
        {{/each}}
      </div>
    </div>

    </div>{{!-- End Main Tab --}}

    {{!-- Extras Tab --}}
    <div class="tab extras-tab" data-group="primary" data-tab="extras">
      <div class="section-header">{{localize "SCIONS.Colony.Extras"}}</div>

      {{!-- Extra Items List --}}
      <div class="extras-list">
        {{#if extraItems}}
          <ol class="items-list">
            {{#each extraItems as |item id|}}
              <li class="item extra-item" data-item-id="{{item._id}}" style="--tint-color: {{item.system.tintColor}};">
                <div class="extra-icon">
                  <img src="{{item.img}}" alt="{{item.name}}" title="{{item.name}}"/>
                </div>
                <div class="extra-content">
                  {{#if item.system.aspect}}
                    <div class="extra-aspect-display">
                      <span class="aspect-label">{{item.system.aspectLabel}}:</span>
                      <span class="aspect-value">{{item.system.aspect}}</span>
                    </div>
                  {{/if}}

                  {{!-- Free Invokes --}}
                  {{#if item.system.invokes}}
                    <div class="extra-invokes">
                      {{#each item.system.invokes as |invoke index|}}
                        <input type="checkbox"
                               class="invoke-checkbox"
                               data-item-id="{{item._id}}"
                               data-index="{{index}}"
                               {{checked invoke.spent}}
                               title="{{#if invoke.spent}}Spent{{else}}Available{{/if}}"/>
                      {{/each}}
                    </div>
                  {{/if}}

                  {{!-- Ladder (Extra-Ladder only) --}}
                  {{#if (eq item.type "extra-ladder")}}
                    <div class="extra-ladder-display">
                      <div class="ladder-label">{{item.system.ladderLabel}}</div>
                      <div class="ladder-rungs-vertical">
                        {{#each item.ladderData.rungs as |rung index|}}
                          <div class="ladder-rung-embedded {{#if rung.checked}}checked{{/if}} {{#if rung.isHighestUnchecked}}highest-unchecked{{/if}}">
                            <div class="ladder-rung-value-box ladder-rung-clickable" data-item-id="{{item._id}}" data-index="{{index}}">
                              {{#if (gt item.system.traumaValue 0)}}
                                <span class="rung-value">{{#if rung.checked}}✗{{else}}{{item.system.traumaValue}}{{/if}}</span>
                              {{else}}
                                <span class="rung-value">{{#if rung.checked}}✗{{/if}}</span>
                              {{/if}}
                            </div>
                            <span class="ladder-rung-aspect-embedded {{#if rung.checked}}checked-aspect{{/if}}">{{rung.aspect}}</span>
                          </div>
                        {{/each}}
                      </div>
                    </div>
                  {{/if}}

                  {{!-- Skill (Extra-Skill only) --}}
                  {{#if (eq item.type "extra-skill")}}
                    {{#if item.system.skillName}}
                      <div class="extra-skill-display">
                        <button type="button" class="roll-button roll-extra-skill" data-item-id="{{item._id}}" title="Roll {{item.system.skillName}}">
                          <i class="fas fa-dice-d6"></i>
                        </button>
                        <span class="skill-label">{{item.system.skillName}} {{signedNumber item.system.skillValue}}</span>
                      </div>
                    {{/if}}
                  {{/if}}

                  {{!-- Track (Extra-Track only) --}}
                  {{#if (eq item.type "extra-track")}}
                    <div class="extra-track-display">
                      <div class="track-label">{{item.system.trackLabel}}</div>
                      <div class="track-boxes-compact">
                        {{#each item.system.boxes as |box index|}}
                          <div class="track-box-wrapper {{#if box.checked}}checked{{/if}}"
                               data-item-id="{{item._id}}"
                               data-index="{{index}}"
                               title="Box {{add index 1}}">
                            {{#if (gt item.system.trackValue 0)}}
                              <span class="track-value">{{#if box.checked}}✗{{else}}{{item.system.trackValue}}{{/if}}</span>
                            {{else}}
                              <span class="track-value">{{#if box.checked}}✗{{/if}}</span>
                            {{/if}}
                          </div>
                        {{/each}}
                      </div>
                    </div>
                  {{/if}}

                  {{!-- Growing Track (Extra-Growing-Track only) --}}
                  {{#if (eq item.type "extra-growing-track")}}
                    <div class="extra-track-display">
                      <div class="track-label">{{item.system.trackLabel}}</div>
                      <div class="track-boxes-compact">
                        {{#each item.system.boxes as |box index|}}
                          <div class="track-box-wrapper {{#if box.checked}}checked{{/if}}"
                               data-item-id="{{item._id}}"
                               data-index="{{index}}"
                               title="Box {{add index 1}}">
                            <span class="track-value">{{#if box.checked}}✗{{else}}{{add index 1}}{{/if}}</span>
                          </div>
                        {{/each}}
                      </div>
                    </div>
                  {{/if}}
                </div>

                <div class="item-controls">
                  <a class="item-control item-edit" title="Edit Extra"><i class="fas fa-edit"></i></a>
                  <a class="item-control item-delete" title="Delete Extra"><i class="fas fa-trash"></i></a>
                </div>
              </li>
            {{/each}}
          </ol>
        {{else}}
          <div class="empty-message">
            <p>No extras yet. Create Extras from the Items directory and drag them here.</p>
          </div>
        {{/if}}
      </div>
    </div>

    {{!-- Named NPCs Tab --}}
    <div class="tab npcs-tab" data-group="primary" data-tab="npcs">
      <div class="section-header">Named NPCs</div>

      {{!-- NPC Items List --}}
      <div class="npc-list">
        {{#if npcItems}}
          <ol class="items-list">
            {{#each npcItems as |item id|}}
              <li class="item npc-item flexrow {{#if item.npcData.isDeceased}}deceased{{/if}}" data-item-id="{{item._id}}">
                <div class="item-details">
                  <div class="item-name">
                    <h4>{{item.name}}</h4>
                    {{#if item.system.aspect}}
                      <div class="item-aspect">{{item.system.aspect}}</div>
                    {{/if}}
                  </div>
                  <div class="item-info">
                    <div class="npc-age-status {{#if item.npcData.isDeceased}}deceased{{/if}}">
                      {{#if item.npcData.isDeceased}}
                        Deceased (Gen {{item.npcData.deathGeneration}})
                      {{else}}
                        {{item.npcData.currentAgeLabel}}
                      {{/if}}
                    </div>
                    {{#if item.system.skillName}}
                      <div class="npc-skill-info">
                        <button type="button" class="roll-button roll-npc-skill rollable" title="Roll {{item.system.skillName}}">
                          <i class="fas fa-dice-d6"></i>
                        </button>
                        <span class="skill-label">{{item.system.skillName}} {{signedNumber item.system.skillValue}}</span>
                      </div>
                    {{/if}}
                  </div>
                </div>
                <div class="item-controls">
                  <a class="item-control item-edit" title="Edit NPC"><i class="fas fa-edit"></i></a>
                  <a class="item-control item-delete" title="Delete NPC"><i class="fas fa-trash"></i></a>
                </div>
              </li>
            {{/each}}
          </ol>
        {{else}}
          <div class="empty-message">
            <p>No NPCs in this colony. Create named NPCs from the Items directory and drag them here.</p>
          </div>
        {{/if}}
      </div>

    </div>

    {{!-- Notes Tab --}}
    <div class="tab notes-tab" data-group="primary" data-tab="notes">
      <div class="section-header">{{localize "SCIONS.Tabs.Notes"}}</div>
      <div class="editor-container">
        {{editor system.notes target="system.notes" button=true owner=owner editable=editable}}
      </div>
    </div>

  </section>

</form>
